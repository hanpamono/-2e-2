<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アリアンロッド2e アイテム管理ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Merriweather&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Merriweather', serif; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Cinzel Decorative', serif; letter-spacing: 0.1em; }
        /* --- (スタイル定義は変更がないため省略) --- */
        .theme-light, .theme-light html { background-color: #f0f9ff; color: #1f2937; }
        .theme-light .card-bg { background-color: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .theme-light .text-title { color: #1e40af; }
        .theme-light .text-body { color: #1f2937; }
        .theme-light .text-muted { color: #6b7280; }
        .theme-light .text-gold { color: #eab308; }
        .theme-light .border-color { border-color: #e5e7eb; }
        .theme-light .hover-bg:hover { background-color: #f3f4f6; }
        .theme-light .btn { border-color: rgba(0,0,0,0.1); }
        .theme-light .btn:hover { border-color: rgba(0,0,0,0.2); }
        .theme-light .btn-primary { background-color: #3b82f6; color: white; }
        .theme-light .btn-primary:hover { background-color: #2563eb; }
        .theme-light .btn-secondary { background-color: #84cc16; color: white; }
        .theme-light .btn-secondary:hover { background-color: #65a30d; }
        .theme-light .input-bg { background-color: white; border-color: #d1d5db; color: #1f2937; }
        .theme-light .input-bg:focus { border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; outline:none; }
        .theme-light .selected-row { background-color: #eff6ff; }
        .theme-dark, .theme-dark html { background-color: #171717; }
        .theme-dark { background-image: url('https://images.unsplash.com/photo-1549317336-206569e8ad8f?q=80&w=2574&auto=format&fit=crop'); background-size: cover; background-position: center; background-attachment: fixed; color: #e5e7eb; }
        .theme-dark .card-bg { background-color: rgba(23, 23, 23, 0.85); backdrop-filter: blur(5px); border: 1px solid rgba(212, 175, 55, 0.3); }
        .theme-dark .text-title { color: #fcd34d; }
        .theme-dark .text-body { color: #e5e7eb; }
        .theme-dark .text-muted { color: #9ca3af; }
        .theme-dark .text-gold { color: #fbbf24; }
        .theme-dark .border-color { border-color: rgba(212, 175, 55, 0.2); }
        .theme-dark .hover-bg:hover { background-color: rgba(255,255,255,0.1); }
        .theme-dark .btn { border-color: rgba(212, 175, 55, 0.6); }
        .theme-dark .btn:hover { border-color: rgba(222, 185, 65, 0.9); }
        .theme-dark .btn-primary { background-color: #0369a1; color: white; }
        .theme-dark .btn-primary:hover { background-color: #0284c7; }
        .theme-dark .btn-secondary { background-color: #059669; color: white; }
        .theme-dark .btn-secondary:hover { background-color: #10b981; }
        .theme-dark .input-bg { background-color: rgba(0,0,0,0.3); border-color: rgba(212, 175, 55, 0.3); color: #e5e7eb; }
        .theme-dark .input-bg:focus { border-color: #fcd34d; outline:none; }
        .theme-dark .selected-row { background-color: rgba(251, 191, 36, 0.15); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .dragging { opacity: 0.5; }
        .drag-over { border-top: 2px solid #FFD700; }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-2 md:p-4">
        <!-- アプリケーションの全体がここに描画されます -->
    </div>

    <script>
        // === Firebaseの初期化設定 (変更なし) ===
        const firebaseConfig = { apiKey: "AIzaSyCXuo4QVfhbpkrkRUo1-blKsNamtvD6vQU", authDomain: "ariannrod2e-manegiment.firebaseapp.com", databaseURL: "https://ariannrod2e-manegiment-default-rtdb.firebaseio.com", projectId: "ariannrod2e-manegiment", storageBucket: "ariannrod2e-manegiment.firebasestorage.app", messagingSenderId: "1085477870210", appId: "1:1085477870210:web:cf443812d635516784329b", measurementId: "G-172C1B7JEF" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // === SVGアイコン定義 (変更なし) ===
        const icons = { plus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`, trash: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`, arrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>`, edit: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`, grip: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 cursor-move"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>`, coin: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="8"></line></svg>`, use: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21h8"/><path d="M12 11v10"/><path d="m19 5-7 7-7-7"/></svg>`, book: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`, link: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>`, logOut: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`, lock: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>` };

        // === アプリケーションの状態管理 (変更なし) ===
        let state = {
            partyId: null, partyList: [], showPartyCreateModal: false,
            partyCreateForm: { name: '', password: '' },
            characters: [], sharedAssets: { money: 0 }, itemTemplates: [], selectedCharacterId: null, logs: [],
            sort: { key: 'name', order: 'asc' }, theme: 'dark', showCharacterModal: false, showItemModal: false, showMoveModal: false, showTemplateModal: false,
            moveItemData: { item: null, quantity: 1 }, characterForm: { name: '', maxWeight: 0 },
            itemForm: { name: '', weight: 0, quantity: 1, sellPrice: 0, type: '武器' }, templateForm: { name: '', weight: 0, sellPrice: 0, type: '武器' },
            showEditCharacterModal: false, editingCharacterId: null, editCharacterForm: { maxWeight: 0 },
            editingItemField: { id: null, field: null }, draggingCharacterId: null, editingSharedMoney: false,
        };
        const appContainer = document.getElementById('app');

        // === データ処理 (変更なし) ===
        function getPartyRef() { if (!state.partyId) return null; return database.ref('parties/' + state.partyId); }
        function updateFirebase() { const partyRef = getPartyRef(); if (!partyRef) return; const dataToSave = { characters: state.characters, sharedAssets: state.sharedAssets, logs: state.logs, itemTemplates: state.itemTemplates, password: state.password }; partyRef.update(dataToSave); }
        function setupDataListener() { const partyRef = getPartyRef(); if (!partyRef) return; partyRef.on('value', (snapshot) => { const data = snapshot.val(); if (data) { state.password = data.password; state.characters = data.characters || []; state.sharedAssets = data.sharedAssets || { money: 0 }; state.logs = data.logs || []; state.itemTemplates = data.itemTemplates || []; if (state.selectedCharacterId && !state.characters.find(c => c.id === state.selectedCharacterId)) { state.selectedCharacterId = null; } } else { window.location.hash = ''; alert('指定されたパーティが見つかりませんでした。'); } render(); }); }

        // === ヘルパー関数 (変更なし) ===
        const addLog = (message) => { const timestamp = new Date().toLocaleString('ja-JP'); const newLog = { id: Date.now(), timestamp, message }; if (!state.logs) state.logs = []; state.logs.unshift(newLog); };
        const calculateCurrentWeight = (character) => { if (!character || !character.items) return 0; let totalWeight = 0; const heaviestWeapon = character.hasWeaponCase ? character.items.filter(item => item.type === '武器').sort((a, b) => b.weight - a.weight)[0] : null; if (character.hasPotionHolder) { const totalPotionCount = character.items .filter(item => item.type === 'ポーション' && item.weight === 1) .reduce((sum, item) => sum + item.quantity, 0); totalWeight += Math.max(0, totalPotionCount - 5); } if (character.hasLunchBox) { const foodItems = character.items.filter(item => item.type === '食料'); const sortedFood = [...foodItems].sort((a, b) => b.weight - a.weight); let freeItemsBudget = 5; sortedFood.forEach(foodItem => { if (freeItemsBudget <= 0) { totalWeight += foodItem.weight * foodItem.quantity; } else { const itemsToMakeFree = Math.min(foodItem.quantity, freeItemsBudget); totalWeight += (foodItem.quantity - itemsToMakeFree) * foodItem.weight; freeItemsBudget -= itemsToMakeFree; } }); } character.items.forEach(item => { if (character.hasPotionHolder && item.type === 'ポーション' && item.weight === 1) return; if (character.hasLunchBox && item.type === '食料') return; let itemWeight = item.weight * item.quantity; if (character.hasToolPouch && item.type === '道具' && item.weight === 1) { itemWeight = (item.quantity - Math.min(item.quantity, 5)) * item.weight; } else if (character.hasQuiver && item.type === '矢弾' && item.weight === 1) { itemWeight = (item.quantity - Math.min(item.quantity, 5)) * item.weight; } else if (heaviestWeapon && item.id === heaviestWeapon.id) { itemWeight = Math.max(0, item.quantity - 1) * item.weight; } totalWeight += itemWeight; }); return totalWeight; };
        const getSelectedCharacter = () => { if (!state.characters) return null; return state.characters.find(c => c.id === state.selectedCharacterId); };
        
        // === イベントハンドラ (変更なし) ===
        function openEditCharacterModal(characterId, event) { event.stopPropagation(); const characterToEdit = state.characters.find(c => c.id === characterId); if (!characterToEdit) return; state.editingCharacterId = characterId; state.editCharacterForm.maxWeight = characterToEdit.maxWeight; state.showEditCharacterModal = true; render(); }
        function handleDragStart(characterId, event) { state.draggingCharacterId = characterId; event.target.classList.add('dragging'); } function handleDragOver(event) { event.preventDefault(); const targetElement = event.target.closest('[draggable="true"]'); if (targetElement) { targetElement.classList.add('drag-over'); } } function handleDragLeave(event) { const targetElement = event.target.closest('[draggable="true"]'); if (targetElement) { targetElement.classList.remove('drag-over'); } } function handleDragEnd(event) { event.target.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); }
        function handleDrop(targetCharacterId, event) { event.preventDefault(); const draggedId = state.draggingCharacterId; if (draggedId === targetCharacterId) return; const draggedItem = state.characters.find(c => c.id === draggedId); const remainingItems = state.characters.filter(c => c.id !== draggedId); const targetIndex = remainingItems.findIndex(c => c.id === targetCharacterId); remainingItems.splice(targetIndex, 0, draggedItem); state.characters = remainingItems; const targetElement = event.target.closest('[draggable="true"]'); if (targetElement) targetElement.classList.remove('drag-over'); state.draggingCharacterId = null; updateFirebase(); }
        function handleSortItems(key) { if (state.sort.key === key) { state.sort.order = state.sort.order === 'asc' ? 'desc' : 'asc'; } else { state.sort.key = key; state.sort.order = 'asc'; } render(); }
        function handleAddCharacter() { const { name, maxWeight } = state.characterForm; if (name.trim() === '' || maxWeight <= 0) { alert('名前と携帯可能重量を正しく入力してください。'); return; } const newCharacter = { id: Date.now(), name: name, maxWeight: Number(maxWeight), items: [], hasWeaponCase: false, hasPotionHolder: false, hasLunchBox: false, hasToolPouch: false, hasQuiver: false, }; if (!state.characters) state.characters = []; state.characters.push(newCharacter); if (!state.selectedCharacterId) { state.selectedCharacterId = newCharacter.id; } addLog(`${newCharacter.name}がパーティに参加しました。`); state.characterForm = { name: '', maxWeight: 0 }; state.showCharacterModal = false; updateFirebase(); }
        function handleUpdateCharacterWeight() { const character = state.characters.find(c => c.id === state.editingCharacterId); if (!character) return; const newMaxWeight = Number(state.editCharacterForm.maxWeight); if (newMaxWeight <= 0) { alert('携帯可能重量は0より大きい値を入力してください。'); return; } const oldMaxWeight = character.maxWeight; character.maxWeight = newMaxWeight; addLog(`${character.name} の携帯可能重量が ${Math.floor(oldMaxWeight)} から ${Math.floor(newMaxWeight)} に変更されました。`); state.showEditCharacterModal = false; state.editingCharacterId = null; updateFirebase(); }
        function handleDeleteCharacter(characterId, event) { event.stopPropagation(); const characterToDelete = state.characters.find(c => c.id === characterId); if (!characterToDelete) return; if (window.confirm(`${characterToDelete.name} を削除しますか？\nこのキャラクターが所持しているアイテムも全て削除されます。`)) { const characterName = characterToDelete.name; state.characters = state.characters.filter(c => c.id !== characterId); addLog(`${characterName} がパーティから離脱しました。`); updateFirebase(); } }
        function handleAddItem() { const selectedCharacter = getSelectedCharacter(); if (!selectedCharacter) return; if (state.itemForm.name.trim() === '') { alert('アイテム名を入力してください。'); return; } const newItem = { id: Date.now(), ...state.itemForm }; if (!selectedCharacter.items) selectedCharacter.items = []; selectedCharacter.items.push(newItem); addLog(`${selectedCharacter.name}が${newItem.name}(${newItem.quantity}個)を獲得しました。`); state.itemForm = { name: '', weight: 0, quantity: 1, sellPrice: 0, type: '武器' }; state.showItemModal = false; updateFirebase(); }
        function handleUpdateItemField(itemId, field, newValueStr) { const selectedCharacter = getSelectedCharacter(); const item = selectedCharacter?.items.find(i => i.id === itemId); if (!item) return; const oldValue = item[field]; let newValue = newValueStr; let fieldName = ''; switch(field) { case 'quantity': fieldName = '個数'; newValue = Number(Math.floor(newValueStr)); if (isNaN(newValue) || newValue < 1) { state.editingItemField = { id: null, field: null }; render(); return; } break; case 'weight': fieldName = '重量'; newValue = Number(Math.floor(newValueStr)); if (isNaN(newValue) || newValue < 0) { state.editingItemField = { id: null, field: null }; render(); return; } break; case 'sellPrice': fieldName = '売却額'; newValue = Number(Math.floor(newValueStr)); if (isNaN(newValue) || newValue < 0) { state.editingItemField = { id: null, field: null }; render(); return; } break; case 'type': fieldName = '種類'; break; } if (oldValue !== newValue) { item[field] = newValue; addLog(`${selectedCharacter.name}が${item.name}の${fieldName}を「${oldValue}」から「${newValue}」に変更しました。`); } state.editingItemField = { id: null, field: null }; updateFirebase(); }
        function handleDeleteItem(itemId) { const selectedCharacter = getSelectedCharacter(); const item = selectedCharacter.items.find(i => i.id === itemId); if (!item || !window.confirm(`${item.name}(${item.quantity}個)を削除(破棄)しますか？この操作では共有財産は増えません。`)) { return; } selectedCharacter.items = selectedCharacter.items.filter(i => i.id !== itemId); addLog(`${selectedCharacter.name}が${item.name}(${item.quantity}個)を破棄しました。`); updateFirebase(); }
        function handleSellItem(itemId) { const selectedCharacter = getSelectedCharacter(); const item = selectedCharacter.items.find(i => i.id === itemId); if (!item) return; const totalSellValue = Number(item.sellPrice) * Number(item.quantity); if (window.confirm(`${item.name}(${item.quantity}個) を合計 ${totalSellValue}G で売却しますか？`)) { const oldMoney = state.sharedAssets.money || 0; state.sharedAssets.money = oldMoney + totalSellValue; selectedCharacter.items = selectedCharacter.items.filter(i => i.id !== itemId); addLog(`${selectedCharacter.name} が ${item.name}(${item.quantity}個) を売却し、共有財産が ${totalSellValue}G 増えました。`); updateFirebase(); } }
        function handleUpdateSharedMoney(newMoneyStr) { const newMoney = Number(Math.floor(newMoneyStr)); if (isNaN(newMoney) || newMoney < 0) { state.editingSharedMoney = false; render(); return; } if (state.sharedAssets.money !== newMoney) { addLog(`共有財産が ${state.sharedAssets.money}G から ${newMoney}G に変更されました。`); state.sharedAssets.money = newMoney; } state.editingSharedMoney = false; updateFirebase(); }
        function handleToggleHolder(holderType) { const selectedCharacter = getSelectedCharacter(); if (!selectedCharacter) return; selectedCharacter[holderType] = !selectedCharacter[holderType]; updateFirebase(); }
        function handleMoveItem(targetCharacterId) { const sourceCharacter = getSelectedCharacter(); const targetCharacter = state.characters.find(c => c.id === targetCharacterId); const sourceItem = sourceCharacter?.items.find(i => i.id === state.moveItemData.item.id); const quantityToMove = Number(Math.floor(state.moveItemData.quantity)); if (!sourceCharacter || !targetCharacter || !sourceItem) return; if (isNaN(quantityToMove) || quantityToMove < 1) { alert("1以上の有効な数値を入力してください。"); return; } if (quantityToMove > sourceItem.quantity) { alert(`移動できるのは最大 ${sourceItem.quantity}個までです。`); return; } const targetItem = targetCharacter.items?.find(i => i.name === sourceItem.name); if (targetItem) { targetItem.quantity += quantityToMove; } else { if (!targetCharacter.items) targetCharacter.items = []; targetCharacter.items.push({ ...sourceItem, id: Date.now(), quantity: quantityToMove }); } sourceItem.quantity -= quantityToMove; if (sourceItem.quantity <= 0) { sourceCharacter.items = sourceCharacter.items.filter(i => i.id !== sourceItem.id); } addLog(`${sourceCharacter.name}が「${sourceItem.name}」を ${quantityToMove}個、${targetCharacter.name}に渡しました。`); state.showMoveModal = false; state.moveItemData = { item: null, quantity: 1 }; updateFirebase(); }
        function handleDeleteLog(logId) { if (!window.confirm('このログを削除しますか？')) return; state.logs = state.logs.filter(log => log.id !== logId); updateFirebase(); }
        function handleClearAllLogs() { if (!window.confirm('全てのログを削除しますか？')) return; state.logs = []; updateFirebase(); }
        function handleUseItem(itemId) { const selectedCharacter = getSelectedCharacter(); const item = selectedCharacter?.items.find(i => i.id === itemId); if (!item) return; const message = `いくつ使用しますか？ (最大: ${item.quantity}個)`; const input = prompt(message, "1"); if (input === null) { return; } const amountToUse = Number(Math.floor(input)); if (isNaN(amountToUse) || amountToUse < 1) { alert("1以上の有効な数値を入力してください。"); return; } if (amountToUse > item.quantity) { alert(`使用できるのは最大 ${item.quantity}個までです。`); return; } item.quantity -= amountToUse; addLog(`${selectedCharacter.name}が「${item.name}」を ${amountToUse}個使用しました。`); if (item.quantity <= 0) { selectedCharacter.items = selectedCharacter.items.filter(i => i.id !== itemId); addLog(`「${item.name}」を使い切りました。`); } updateFirebase(); }
        function handleToggleTheme() { state.theme = state.theme === 'dark' ? 'light' : 'dark'; localStorage.setItem('arianrod-theme', state.theme); }
        function handleAddTemplate() { const { name, weight, sellPrice, type } = state.templateForm; if (name.trim() === '') { alert('テンプレート名を入力してください。'); return; } const newTemplate = { id: Date.now(), name, weight: Number(weight), sellPrice: Number(sellPrice), type }; if (!state.itemTemplates) state.itemTemplates = []; state.itemTemplates.push(newTemplate); state.templateForm = { name: '', weight: 0, sellPrice: 0, type: '武器' }; updateFirebase(); }
        function handleDeleteTemplate(templateId) { if (!window.confirm("このテンプレートを削除しますか？")) return; state.itemTemplates = state.itemTemplates.filter(t => t.id !== templateId); updateFirebase(); }
        function handleSelectTemplate(templateId) { if (!templateId) { state.itemForm = { name: '', weight: 0, quantity: 1, sellPrice: 0, type: '武器' }; } else { const template = state.itemTemplates.find(t => t.id === Number(templateId)); if (template) { state.itemForm = { ...state.itemForm, name: template.name, weight: template.weight, sellPrice: template.sellPrice, type: template.type }; } } render(); }

        // === パーティ管理用のイベントハンドラ (変更なし) ===
        function handleConfirmCreateParty() { const { name, password } = state.partyCreateForm; if (name.trim() === '') { alert('パーティ名を入力してください。'); return; } const newPartyId = 'p' + Date.now().toString(36) + Math.random().toString(36).substring(2, 7); const partyMetaRef = database.ref('party_meta/' + newPartyId); const partyDataRef = database.ref('parties/' + newPartyId); const initialPartyData = { characters: [], sharedAssets: { money: 0 }, logs: [], itemTemplates: [], password: password || '' }; const partyMetaData = { name: name, hasPassword: !!password }; partyDataRef.set(initialPartyData).then(() => { partyMetaRef.set(partyMetaData).then(() => { state.partyCreateForm = { name: '', password: '' }; state.showPartyCreateModal = false; window.location.hash = newPartyId; }); }); }
        function handleJoinParty(partyId, meta) { if (meta.hasPassword) { const inputPassword = prompt(`「${meta.name}」に参加するにはパスワードが必要です:\nパスワードを入力してください`); if (inputPassword === null) return; database.ref('parties/' + partyId + '/password').once('value', snapshot => { const correctPassword = snapshot.val(); if (inputPassword === correctPassword) { window.location.hash = partyId; } else { alert('パスワードが違います。'); } }); } else { window.location.hash = partyId; } }
        function handleCopyPartyLink() { navigator.clipboard.writeText(window.location.href).then(() => alert('パーティの招待リンクをコピーしました！')).catch(err => alert('コピーに失敗しました。')); }
        function handleCopyPartyId() { navigator.clipboard.writeText(state.partyId).then(() => alert('パーティIDをコピーしました！')).catch(err => alert('コピーに失敗しました。')); }
        function handleLeaveParty() { if (window.confirm('現在のパーティから退出しますか？\n最初の画面に戻ります。')) { window.location.hash = ''; } }
        
        // ▼▼▼ 【修正点】render関数を修正 ▼▼▼
        function render() {
            document.body.className = `theme-${state.theme}`;

            // パーティIDがない場合は、ロビー画面とモーダルを描画
            if (!state.partyId) {
                appContainer.innerHTML = renderLobby() + renderModals();
                return;
            }

            // --- ここから下はパーティIDがある場合のメイン画面描画 (内容は変更なし) ---
            const selectedCharacter = state.characters ? getSelectedCharacter() : null;
            const currentWeight = selectedCharacter ? calculateCurrentWeight(selectedCharacter) : 0;
            const isOverWeight = selectedCharacter ? currentWeight > selectedCharacter.maxWeight : false;

            let sortedItems = [];
            if (selectedCharacter && selectedCharacter.items) { sortedItems = [...selectedCharacter.items].sort((a, b) => { const key = state.sort.key; const order = state.sort.order === 'asc' ? 1 : -1; const valA = a[key]; const valB = b[key]; if (typeof valA === 'number' && typeof valB === 'number') { return (valA - valB) * order; } if (typeof valA === 'string' && typeof valB === 'string') { return valA.localeCompare(valB) * order; } return 0; }); }
            
            appContainer.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-y-4">
                        <h1 class="text-4xl md:text-5xl font-bold text-title" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.2);"> アイテム管理ツール </h1>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button onclick="handleLeaveParty()" class="btn ${state.theme === 'dark' ? 'bg-red-900/50 hover:bg-red-800/50 text-red-300' : 'bg-red-100 hover:bg-red-200 text-red-600'} text-sm px-4 py-2 rounded-lg flex items-center gap-2"> ${icons.logOut} パーティ退出</button>
                            <button onclick="state.showTemplateModal = true; render()" class="btn bg-gray-500/10 hover:bg-gray-500/20 text-sm px-4 py-2 rounded-lg text-body flex items-center gap-2"> ${icons.book} アイテム図鑑</button>
                            <button onclick="handleToggleTheme(); render()" class="btn bg-gray-500/10 hover:bg-gray-500/20 text-sm px-4 py-2 rounded-lg text-body"> ${state.theme === 'dark' ? 'ライトテーマへ' : 'ダークテーマへ'} </button>
                        </div>
                    </div>
                    <div class="card-bg rounded-lg shadow-lg p-4 mb-6 flex flex-wrap justify-between items-center gap-4">
                        <div>
                            <span class="text-muted text-lg">パーティID: </span>
                            <strong onclick="handleCopyPartyId()" class="text-xl text-title font-mono cursor-pointer bg-black/10 px-2 py-1 rounded" title="クリックしてIDをコピー">${state.partyId}</strong>
                        </div>
                        <button onclick="handleCopyPartyLink()" class="btn btn-primary text-white text-base px-4 py-2 rounded-lg flex items-center gap-2" title="仲間を招待するためのリンクをコピーします"> ${icons.link} 招待リンクをコピー </button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div>
                            <div class="card-bg rounded-lg shadow-lg p-6 mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-semibold text-title">キャラクター一覧</h2>
                                    <button onclick="state.showCharacterModal = true; render();" class="btn btn-secondary text-white px-3 py-1 rounded-md flex items-center gap-1 text-base"> ${icons.plus} 追加 </button>
                                </div>
                                <div class="space-y-2">
                                    ${ (state.characters || []).map(character => {
                                        const weight = calculateCurrentWeight(character);
                                        const isOver = weight > character.maxWeight;
                                        const isSelected = character.id === state.selectedCharacterId;
                                        return `<div draggable="true" ondragstart="handleDragStart(${character.id}, event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(${character.id}, event)" ondragend="handleDragEnd(event)" onclick="state.selectedCharacterId = ${character.id}; render()" class="p-3 rounded-lg transition-all duration-200 flex items-center gap-3 ${isSelected ? 'selected-row border-blue-500' : 'bg-black/5 hover-bg border-transparent'} ${isOver ? 'bg-red-500/10 border-red-500' : ''} border"> <div>${icons.grip}</div> <div class="flex-grow"> <div class="flex justify-between items-center"> <div class="font-bold text-xl text-body">${character.name}</div> <div class="flex items-center gap-1"> <button onclick="openEditCharacterModal(${character.id}, event)" class="text-sky-500 hover:text-sky-700 p-1 rounded-full hover-bg transition-colors" title="携帯可能重量を編集"> ${icons.edit} </button> <button onclick="handleDeleteCharacter(${character.id}, event)" class="text-red-500 hover:text-red-700 p-1 rounded-full hover-bg transition-colors" title="${character.name}を削除"> ${icons.trash} </button> </div> </div> <div class="text-lg ${isOver ? 'text-red-600 font-semibold' : 'text-muted'}"> ${Math.floor(weight)} / ${Math.floor(character.maxWeight)} ${isOver ? '(超過!)' : ''} </div> </div> </div>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="card-bg rounded-lg shadow-lg p-6">
                                <h2 class="text-2xl font-semibold mb-2 text-title">共有財産</h2>
                                <div class="text-4xl font-bold text-gold" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.2);">
                                    ${state.editingSharedMoney ? `<input type="number" value="${state.sharedAssets.money || 0}" class="w-full bg-transparent text-right border-b-2 border-gold focus:outline-none" onblur="handleUpdateSharedMoney(this.value)" onkeydown="if(event.key === 'Enter') this.blur(); if(event.key === 'Escape') { state.editingSharedMoney = false; render(); }" autofocus onfocus="this.select()">` : `<span onclick="state.editingSharedMoney = true; render();" class="cursor-pointer hover-bg px-2 py-1 rounded">${state.sharedAssets.money || 0} G</span>`}
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 card-bg rounded-lg shadow-lg p-6">
                            ${selectedCharacter ? `
                                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                    <div> <h2 class="text-3xl font-semibold text-title">${selectedCharacter.name}の所持品</h2> <p class="text-lg ${isOverWeight ? 'text-red-600 font-semibold' : 'text-muted'}"> 現在重量: ${Math.floor(currentWeight)} / ${Math.floor(selectedCharacter.maxWeight)} ${isOverWeight ? '(超過!)' : ''} </p> </div>
                                    <button onclick="state.showItemModal = true; render();" class="btn btn-secondary text-white px-4 py-2 rounded-md flex items-center gap-2 text-base"> ${icons.plus} アイテム追加 </button>
                                </div>
                                <div class="mb-4 p-3 bg-black/5 rounded-lg border border-color">
                                     <h3 class="font-semibold mb-2 text-title text-lg">特殊アイテム</h3>
                                     <div class="flex flex-wrap gap-2">
                                        <button onclick="handleToggleHolder('hasWeaponCase')" class="px-3 py-1 text-sm rounded-full transition-colors text-white ${selectedCharacter.hasWeaponCase ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-gray-500 hover:bg-gray-600'}"> ウェポンケース ${selectedCharacter.hasWeaponCase ? 'ON' : 'OFF'} </button>
                                        <button onclick="handleToggleHolder('hasPotionHolder')" class="px-3 py-1 text-sm rounded-full transition-colors text-white ${selectedCharacter.hasPotionHolder ? 'bg-sky-500 hover:bg-sky-600' : 'bg-gray-500 hover:bg-gray-600'}"> ポーションホルダー ${selectedCharacter.hasPotionHolder ? 'ON' : 'OFF'} </button>
                                        <button onclick="handleToggleHolder('hasLunchBox')" class="px-3 py-1 text-sm rounded-full transition-colors text-white ${selectedCharacter.hasLunchBox ? 'bg-amber-500 hover:bg-amber-600' : 'bg-gray-500 hover:bg-gray-600'}"> ランチボックス ${selectedCharacter.hasLunchBox ? 'ON' : 'OFF'} </button>
                                        <button onclick="handleToggleHolder('hasToolPouch')" class="px-3 py-1 text-sm rounded-full transition-colors text-white ${selectedCharacter.hasToolPouch ? 'bg-teal-500 hover:bg-teal-600' : 'bg-gray-500 hover:bg-gray-600'}"> 小道具入れ ${selectedCharacter.hasToolPouch ? 'ON' : 'OFF'} </button>
                                        <button onclick="handleToggleHolder('hasQuiver')" class="px-3 py-1 text-sm rounded-full transition-colors text-white ${selectedCharacter.hasQuiver ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-500 hover:bg-gray-600'}"> 矢筒 ${selectedCharacter.hasQuiver ? 'ON' : 'OFF'} </button>
                                     </div>
                                </div>
                                <div class="hidden md:block overflow-x-auto">
                                    <table class="w-full border-collapse border-color text-lg">
                                        <thead class="bg-black/5">
                                            <tr>
                                                <th class="border-b border-color p-3 text-left"><button onclick="handleSortItems('name')" class="font-bold w-full text-left text-title">アイテム名 ${state.sort.key === 'name' ? (state.sort.order === 'asc' ? '▲' : '▼') : ''}</button></th>
                                                <th class="border-b border-color p-3 text-left"><button onclick="handleSortItems('type')" class="font-bold w-full text-left text-title">種類 ${state.sort.key === 'type' ? (state.sort.order === 'asc' ? '▲' : '▼') : ''}</button></th>
                                                <th class="border-b border-color p-3 text-right"><button onclick="handleSortItems('weight')" class="font-bold w-full text-right text-title">重量 ${state.sort.key === 'weight' ? (state.sort.order === 'asc' ? '▲' : '▼') : ''}</button></th>
                                                <th class="border-b border-color p-3 text-right"><button onclick="handleSortItems('quantity')" class="font-bold w-full text-right text-title">個数 ${state.sort.key === 'quantity' ? (state.sort.order === 'asc' ? '▲' : '▼') : ''}</button></th>
                                                <th class="border-b border-color p-3 text-right"><button onclick="handleSortItems('sellPrice')" class="font-bold w-full text-right text-title">売却額 ${state.sort.key === 'sellPrice' ? (state.sort.order === 'asc' ? '▲' : '▼') : ''}</button></th>
                                                <th class="border-b border-color p-3 text-center text-title">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${sortedItems.map(item => `<tr class="hover-bg"><td class="border-b border-color p-3">${item.name}</td><td class="border-b border-color p-3"> ${state.editingItemField.id === item.id && state.editingItemField.field === 'type' ? `<select class="w-full input-bg border rounded px-1" onchange="handleUpdateItemField(${item.id}, 'type', this.value)" onblur="state.editingItemField = {id: null, field: null}; render();" autofocus> <option>武器</option><option>ポーション</option><option>食料</option><option>道具</option><option>矢弾</option><option>その他</option> </select>` : `<span onclick="state.editingItemField = {id: ${item.id}, field: 'type'}; render();" class="cursor-pointer hover-bg px-1 rounded">${item.type}</span>`} </td><td class="border-b border-color p-3 text-right"> ${state.editingItemField.id === item.id && state.editingItemField.field === 'weight' ? `<input type="number" value="${item.weight}" class="w-16 input-bg text-right border rounded px-1" onblur="handleUpdateItemField(${item.id}, 'weight', this.value)" onkeydown="if(event.key === 'Enter') this.blur()" autofocus onfocus="this.select()">` : `<span onclick="state.editingItemField = {id: ${item.id}, field: 'weight'}; render();" class="cursor-pointer hover-bg px-1 rounded">${item.weight}</span>`} </td><td class="border-b border-color p-3 text-right"> ${state.editingItemField.id === item.id && state.editingItemField.field === 'quantity' ? `<input type="number" value="${item.quantity}" class="w-16 input-bg text-right border rounded px-1" onblur="handleUpdateItemField(${item.id}, 'quantity', this.value)" onkeydown="if(event.key === 'Enter') this.blur()" autofocus onfocus="this.select()">` : `<span onclick="state.editingItemField = {id: ${item.id}, field: 'quantity'}; render();" class="cursor-pointer hover-bg px-1 rounded">${item.quantity}</span>`} </td><td class="border-b border-color p-3 text-right"> ${state.editingItemField.id === item.id && state.editingItemField.field === 'sellPrice' ? `<input type="number" value="${item.sellPrice}" class="w-20 input-bg text-right border rounded px-1" onblur="handleUpdateItemField(${item.id}, 'sellPrice', this.value)" onkeydown="if(event.key === 'Enter') this.blur()" autofocus onfocus="this.select()">` : `<span onclick="state.editingItemField = {id: ${item.id}, field: 'sellPrice'}; render();" class="cursor-pointer hover-bg px-1 rounded">${item.sellPrice}</span>`} </td><td class="border-b border-color p-3"><div class="flex gap-1 justify-center"><button onclick="handleUseItem(${item.id})" class="btn text-white p-1 rounded ${state.theme === 'dark' ? 'bg-emerald-700 hover:bg-emerald-600' : 'bg-lime-500 hover:bg-lime-600'}" title="使用"> ${icons.use} </button><button onclick="handleSellItem(${item.id})" class="btn text-white p-1 rounded ${state.theme === 'dark' ? 'bg-amber-600 hover:bg-amber-500' : 'bg-yellow-500 hover:bg-yellow-600'}" title="売却"> ${icons.coin} </button><button onclick='state.moveItemData = { item: ${JSON.stringify(item)}, quantity: 1 }; state.showMoveModal = true; render();' class="btn btn-primary text-white p-1 rounded" title="移動">${icons.arrowRight}</button><button onclick="handleDeleteItem(${item.id})" class="btn text-white p-1 rounded ${state.theme === 'dark' ? 'bg-red-800 hover:bg-red-700' : 'bg-rose-500 hover:bg-rose-600'}" title="削除（破棄）">${icons.trash}</button></div></td></tr>`).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="md:hidden space-y-3">
                                    ${sortedItems.map(item => `<div class="bg-black/10 border border-color rounded-lg p-3"><div class="font-bold text-xl text-body mb-2">${item.name}</div><div class="grid grid-cols-2 gap-x-4 gap-y-1 text-base text-muted"><div><span class="font-semibold text-gray-500">種類:</span> ${item.type}</div><div><span class="font-semibold text-gray-500">個数:</span> ${item.quantity}</div><div><span class="font-semibold text-gray-500">重量:</span> ${item.weight}</div><div><span class="font-semibold text-gray-500">売却額:</span> ${item.sellPrice} G</div></div><div class="mt-3 pt-3 border-t border-color flex gap-2 justify-end"><button onclick="handleUseItem(${item.id})" class="flex-1 btn text-white px-3 py-1 text-base rounded-md flex items-center justify-center gap-1 ${state.theme === 'dark' ? 'bg-emerald-700 hover:bg-emerald-600' : 'bg-lime-500 hover:bg-lime-600'}"> ${icons.use} 使用</button><button onclick="handleSellItem(${item.id})" class="flex-1 btn text-white px-3 py-1 text-base rounded-md flex items-center justify-center gap-1 ${state.theme === 'dark' ? 'bg-amber-600 hover:bg-amber-500' : 'bg-yellow-500 hover:bg-yellow-600'}"> ${icons.coin} 売却</button><button onclick='state.moveItemData = { item: ${JSON.stringify(item)}, quantity: 1 }; state.showMoveModal = true; render();' class="btn btn-primary text-white p-2 rounded-md" title="移動">${icons.arrowRight}</button><button onclick="handleDeleteItem(${item.id})" class="btn text-white p-2 rounded-md ${state.theme === 'dark' ? 'bg-red-800 hover:bg-red-700' : 'bg-rose-500 hover:bg-rose-600'}" title="削除（破棄）">${icons.trash}</button></div></div>`).join('')}
                                </div>
                            ` : `<div class="text-center text-muted py-12 text-lg">キャラクターを選択してください</div>`}
                        </div>
                    </div>
                    <div class="card-bg rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-title">アクションログ</h2>
                            ${(state.logs && state.logs.length > 0) ? `<button onclick="handleClearAllLogs()" class="btn ${state.theme === 'dark' ? 'bg-red-800 hover:bg-red-700' : 'bg-rose-500 hover:bg-rose-600'} text-white px-3 py-1 rounded text-base flex items-center gap-1">${icons.trash} 全削除</button>` : ''}
                        </div>
                        <div class="max-h-64 overflow-y-auto border border-color rounded p-4 bg-black/10">
                            ${(!state.logs || state.logs.length === 0) ? `<p class="text-center text-muted">まだログがありません</p>` : `<div class="space-y-1">${state.logs.map(log => `<div class="text-base flex justify-between items-center hover-bg px-2 py-1 rounded group"><div><span class="text-muted">${log.timestamp}</span><span class="mx-2 text-muted/50">|</span><span>${log.message}</span></div><button onclick="handleDeleteLog(${log.id})" class="opacity-0 group-hover:opacity-100 bg-red-500 hover:bg-red-600 text-white p-1 rounded transition-opacity" title="このログを削除"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`).join('')}</div>`}
                        </div>
                    </div>
                </div>
                ${renderModals()}
            `;
        }
        
        // === パーティ作成・参加画面の描画 (変更なし) ===
        function renderLobby() { const partyListHtml = state.partyList.map(party => `<button onclick='handleJoinParty("${party.id}", ${JSON.stringify(party.meta)})' class="w-full btn border-color text-left p-4 rounded-lg hover-bg flex justify-between items-center"> <span class="text-xl text-body">${party.meta.name}</span> ${party.meta.hasPassword ? `<span class="text-muted">${icons.lock}</span>` : ''} </button>`).join(''); return `<div class="flex items-center justify-center min-h-screen"> <div class="w-full max-w-lg mx-auto"> <div class="card-bg rounded-lg shadow-2xl p-8"> <h1 class="text-3xl md:text-4xl font-bold text-center text-title mb-8">アイテム管理ツール</h1> <div class="space-y-6"> <div> <button onclick="state.showPartyCreateModal = true; render();" class="w-full btn btn-secondary text-white rounded-lg py-3 text-lg font-bold flex items-center justify-center gap-2"> ${icons.plus} 新しいパーティを作成 </button> </div> <div> <h2 class="text-2xl font-semibold text-center text-title mb-4 border-b border-color pb-2">参加可能なパーティ</h2> <div class="space-y-3 max-h-64 overflow-y-auto pr-2"> ${state.partyList.length > 0 ? partyListHtml : '<p class="text-center text-muted py-4">現在、参加可能なパーティーはありません。</p>'} </div> </div> </div> </div> </div> </div>`; }
        
        // === モーダル描画関数 (変更なし) ===
        function renderModals() {
            let modalHTML = '';
            if (state.showPartyCreateModal) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-96"> <h3 class="text-xl font-semibold mb-4 text-title">新しいパーティを作成</h3> <div class="space-y-4"> <div> <label class="block text-base font-medium mb-1 text-muted">パーティ名</label> <input type="text" value="${state.partyCreateForm.name}" oninput="state.partyCreateForm.name = this.value" class="w-full input-bg rounded px-3 py-2" placeholder="例: 冒険者ギルド「暁」"> </div> <div> <label class="block text-base font-medium mb-1 text-muted">パスワード (任意)</label> <input type="password" value="${state.partyCreateForm.password}" oninput="state.partyCreateForm.password = this.value" class="w-full input-bg rounded px-3 py-2" placeholder="設定しない場合は空欄"> </div> </div> <div class="flex justify-end space-x-2 mt-6"> <button onclick="state.showPartyCreateModal = false; render();" class="btn px-4 py-2 ${state.theme === 'dark' ? 'bg-stone-700 hover:bg-stone-600' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'} rounded text-base">キャンセル</button> <button onclick="handleConfirmCreateParty()" class="btn px-4 py-2 btn-secondary text-white rounded text-base">作成</button> </div> </div> </div>`; }
            if (state.showCharacterModal) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-96"> <h3 class="text-xl font-semibold mb-4 text-title">キャラクター追加</h3> <div class="space-y-4"> <div> <label class="block text-base font-medium mb-1 text-muted">キャラクター名</label> <input type="text" value="${state.characterForm.name}" oninput="state.characterForm.name = this.value" class="w-full input-bg rounded px-3 py-2"> </div> <div> <label class="block text-base font-medium mb-1 text-muted">携帯可能重量</label> <input type="number" min="0" value="${state.characterForm.maxWeight}" oninput="state.characterForm.maxWeight = Number(this.value)" class="w-full input-bg rounded px-3 py-2"> </div> </div> <div class="flex justify-end space-x-2 mt-6"> <button onclick="state.showCharacterModal = false; render();" class="btn px-4 py-2 ${state.theme === 'dark' ? 'bg-stone-700 hover:bg-stone-600' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'} rounded text-base">キャンセル</button> <button onclick="handleAddCharacter()" class="btn px-4 py-2 btn-secondary text-white rounded text-base">追加</button> </div> </div> </div>`; }
            if (state.showItemModal) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-96"> <h3 class="text-xl font-semibold mb-4 text-title">アイテム追加</h3> <div class="space-y-4"> <div> <label class="block text-base font-medium mb-1 text-muted">図鑑から選ぶ</label> <select onchange="handleSelectTemplate(this.value)" class="w-full input-bg rounded px-3 py-2"><option value="">カスタムアイテム</option>${state.itemTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}</select> </div> <hr class="border-color"> <div> <label class="block text-base font-medium mb-1 text-muted">アイテム名</label> <input type="text" value="${state.itemForm.name}" oninput="state.itemForm.name = this.value" class="w-full input-bg rounded px-3 py-2"> </div> <div class="grid grid-cols-2 gap-4"> <div> <label class="block text-base font-medium mb-1 text-muted">重量</label> <input type="number" min="0" step="1" value="${state.itemForm.weight}" oninput="this.value = Math.floor(this.value || 0); state.itemForm.weight = Number(this.value);" class="w-full input-bg rounded px-3 py-2"/> </div> <div> <label class="block text-base font-medium mb-1 text-muted">個数</label> <input type="number" min="1" value="${state.itemForm.quantity}" oninput="state.itemForm.quantity = Number(this.value)" class="w-full input-bg rounded px-3 py-2"/> </div> </div> <div> <label class="block text-base font-medium mb-1 text-muted">売却金額</label> <input type="number" min="0" value="${state.itemForm.sellPrice}" oninput="state.itemForm.sellPrice = Number(this.value)" class="w-full input-bg rounded px-3 py-2"/> </div> <div> <label class="block text-base font-medium mb-1 text-muted">種類</label> <select onchange="state.itemForm.type = this.value" class="w-full input-bg rounded px-3 py-2"> <option value="武器" ${state.itemForm.type === '武器' ? 'selected' : ''}>武器</option> <option value="ポーション" ${state.itemForm.type === 'ポーション' ? 'selected' : ''}>ポーション</option> <option value="食料" ${state.itemForm.type === '食料' ? 'selected' : ''}>食料</option> <option value="道具" ${state.itemForm.type === '道具' ? 'selected' : ''}>道具</option> <option value="矢弾" ${state.itemForm.type === '矢弾' ? 'selected' : ''}>矢弾</option> <option value="その他" ${state.itemForm.type === 'その他' ? 'selected' : ''}>その他</option> </select> </div> </div> <div class="flex justify-end space-x-2 mt-6"> <button onclick="state.showItemModal = false; state.itemForm = { name: '', weight: 0, quantity: 1, sellPrice: 0, type: '武器' }; render();" class="btn px-4 py-2 ${state.theme === 'dark' ? 'bg-stone-700 hover:bg-stone-600' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'} rounded text-base">キャンセル</button> <button onclick="handleAddItem()" class="btn px-4 py-2 btn-secondary text-white rounded text-base">追加</button> </div> </div> </div>`; }
            if (state.showMoveModal && state.moveItemData.item) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-96"> <h3 class="text-xl font-semibold mb-4 text-title">アイテム移動</h3> <p class="mb-2 text-muted text-lg"><strong>${state.moveItemData.item.name}</strong> を誰に渡しますか？</p> <div class="mb-4"> <label class="block text-base font-medium mb-1 text-muted">渡す個数 (最大: ${state.moveItemData.item.quantity})</label> <input type="number" min="1" max="${state.moveItemData.item.quantity}" value="${state.moveItemData.quantity}" oninput="state.moveItemData.quantity = this.value" class="w-full input-bg rounded px-3 py-2"> </div> <div class="space-y-2 mb-6"> ${state.characters.filter(c => c.id !== state.selectedCharacterId).map(character => `<button onclick="handleMoveItem(${character.id})" class="btn w-full text-left p-3 border-color rounded hover-bg text-lg"> ${character.name} </button>`).join('')} </div> <div class="flex justify-end"> <button onclick="state.showMoveModal = false; state.moveItemData = {item: null, quantity: 1}; render();" class="btn px-4 py-2 ${state.theme === 'dark' ? 'bg-stone-700 hover:bg-stone-600' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'} rounded text-base">キャンセル</button> </div> </div> </div>`; }
            if (state.showEditCharacterModal) { const character = state.characters.find(c => c.id === state.editingCharacterId); if(character) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-96"> <h3 class="text-xl font-semibold mb-4 text-title">${character.name} の携帯可能重量を編集</h3> <div class="space-y-4"> <div> <label class="block text-base font-medium mb-1 text-muted">新しい携帯可能重量</label> <input type="number" min="0" value="${state.editCharacterForm.maxWeight}" oninput="state.editCharacterForm.maxWeight = this.value" class="w-full input-bg rounded px-3 py-2" > </div> </div> <div class="flex justify-end space-x-2 mt-6"> <button onclick="state.showEditCharacterModal = false; state.editingCharacterId = null; render();" class="btn px-4 py-2 ${state.theme === 'dark' ? 'bg-stone-700 hover:bg-stone-600' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'} rounded text-base">キャンセル</button> <button onclick="handleUpdateCharacterWeight()" class="btn px-4 py-2 btn-primary text-white rounded text-base">更新</button> </div> </div> </div>`; } }
            if (state.showTemplateModal) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-full max-w-2xl"> <h3 class="text-2xl font-semibold mb-4 text-title">アイテム図鑑</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h4 class="text-xl font-semibold mb-3 text-title">新規登録</h4><div class="space-y-3 p-4 bg-black/10 border border-color rounded-lg"><div><label class="block text-base font-medium mb-1 text-muted">名前</label><input type="text" oninput="state.templateForm.name = this.value" class="w-full input-bg rounded px-3 py-2"></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-base font-medium mb-1 text-muted">重量</label><input type="number" min="0" oninput="state.templateForm.weight = this.value" class="w-full input-bg rounded px-3 py-2"></div><div><label class="block text-base font-medium mb-1 text-muted">売却額</label><input type="number" min="0" oninput="state.templateForm.sellPrice = this.value" class="w-full input-bg rounded px-3 py-2"></div></div><div><label class="block text-base font-medium mb-1 text-muted">種類</label><select onchange="state.templateForm.type = this.value" class="w-full input-bg rounded px-3 py-2"><option>武器</option><option>ポーション</option><option>食料</option><option>道具</option><option>矢弾</option><option>その他</option></select></div><button onclick="handleAddTemplate()" class="w-full btn btn-secondary text-white rounded py-2 mt-2">テンプレートに追加</button></div></div><div><h4 class="text-xl font-semibold mb-3 text-title">登録済みリスト</h4><div class="space-y-2 max-h-64 overflow-y-auto pr-2">${(state.itemTemplates || []).map(t => `<div class="flex justify-between items-center p-2 rounded hover-bg"><span>${t.name} <span class="text-sm text-muted">(${t.type})</span></span><button onclick="handleDeleteTemplate(${t.id})" class="text-red-400 hover:text-red-300 p-1 rounded-full hover-bg transition-colors" title="削除">${icons.trash}</button></div>`).join('')}</div></div></div><div class="flex justify-end mt-6"><button onclick="state.showTemplateModal=false; render();" class="btn px-4 py-2 ${state.theme === 'dark' ? 'bg-stone-700 hover:bg-stone-600' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'} rounded text-base">閉じる</button></div></div></div>`; }
            return modalHTML;
        }

        // === アプリケーションの初期化処理 (変更なし) ===
        function fetchPartyList() { database.ref('party_meta').on('value', snapshot => { const data = snapshot.val() || {}; state.partyList = Object.keys(data).map(key => ({ id: key, meta: data[key] })); render(); }); }
        function initializeApp() {
            const savedTheme = localStorage.getItem('arianrod-theme') || 'dark';
            state.theme = savedTheme;
            const partyId = window.location.hash.substring(1);
            if (partyId) {
                state.partyId = partyId;
                setupDataListener();
            } else {
                if (state.partyId) {
                    database.ref('parties/' + state.partyId).off();
                    Object.assign(state, { partyId: null, characters: [], sharedAssets: { money: 0 }, logs: [], itemTemplates: [], selectedCharacterId: null });
                }
                fetchPartyList();
            }
        }
        window.addEventListener('hashchange', initializeApp);
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アリアンロッド2e アイテム管理ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Merriweather&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Merriweather', serif; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Cinzel Decorative', serif; letter-spacing: 0.1em; }
        /* ライト/ダークテーマのCSSは変更ないため省略 */
        .theme-light, .theme-light html { background-color: #f0f9ff; color: #1f2937; }
        .theme-light .card-bg { background-color: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .theme-light .text-title { color: #1e40af; }
        .theme-light .text-body { color: #1f2937; }
        .theme-light .text-muted { color: #6b7280; }
        .theme-light .text-gold { color: #eab308; }
        .theme-light .border-color { border-color: #e5e7eb; }
        .theme-light .hover-bg:hover { background-color: #f3f4f6; }
        .theme-light .btn { border-color: rgba(0,0,0,0.1); }
        .theme-light .btn:hover { border-color: rgba(0,0,0,0.2); }
        .theme-light .btn-primary { background-color: #3b82f6; color: white; }
        .theme-light .btn-primary:hover { background-color: #2563eb; }
        .theme-light .btn-secondary { background-color: #84cc16; color: white; }
        .theme-light .btn-secondary:hover { background-color: #65a30d; }
        .theme-light .input-bg { background-color: white; border-color: #d1d5db; color: #1f2937; }
        .theme-light .input-bg:focus { border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; outline:none; }
        .theme-light .selected-row { background-color: #eff6ff; }
        .theme-dark, .theme-dark html { background-color: #171717; }
        .theme-dark { background-image: url('https://images.unsplash.com/photo-1549317336-206569e8ad8f?q=80&w=2574&auto-format&fit=crop'); background-size: cover; background-position: center; background-attachment: fixed; color: #e5e7eb; }
        .theme-dark .card-bg { background-color: rgba(23, 23, 23, 0.85); backdrop-filter: blur(5px); border: 1px solid rgba(212, 175, 55, 0.3); }
        .theme-dark .text-title { color: #fcd34d; }
        .theme-dark .text-body { color: #e5e7eb; }
        .theme-dark .text-muted { color: #9ca3af; }
        .theme-dark .text-gold { color: #fbbf24; }
        .theme-dark .border-color { border-color: rgba(212, 175, 55, 0.2); }
        .theme-dark .hover-bg:hover { background-color: rgba(255,255,255,0.1); }
        .theme-dark .btn { border-color: rgba(212, 175, 55, 0.6); }
        .theme-dark .btn:hover { border-color: rgba(222, 185, 65, 0.9); }
        .theme-dark .btn-primary { background-color: #0369a1; color: white; }
        .theme-dark .btn-primary:hover { background-color: #0284c7; }
        .theme-dark .btn-secondary { background-color: #059669; color: white; }
        .theme-dark .btn-secondary:hover { background-color: #10b981; }
        .theme-dark .input-bg { background-color: rgba(0,0,0,0.3); border-color: rgba(212, 175, 55, 0.3); color: #e5e7eb; }
        .theme-dark .input-bg:focus { border-color: #fcd34d; outline:none; }
        .theme-dark .selected-row { background-color: rgba(251, 191, 36, 0.15); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .dragging { opacity: 0.5; }
        .drag-over { border-top: 2px solid #FFD700; }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-2 md:p-4">
        <!-- アプリケーションの全体がここに描画されます -->
    </div>

    <script>
        // === Firebaseの初期化設定 (変更なし) ===
        const firebaseConfig = { apiKey: "AIzaSyCXuo4QVfhbpkrkRUo1-blKsNamtvD6vQU", authDomain: "ariannrod2e-manegiment.firebaseapp.com", databaseURL: "https://ariannrod2e-manegiment-default-rtdb.firebaseio.com", projectId: "ariannrod2e-manegiment", storageBucket: "ariannrod2e-manegiment.firebasestorage.app", messagingSenderId: "1085477870210", appId: "1:1085477870210:web:cf443812d635516784329b", measurementId: "G-172C1B7JEF" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // === SVGアイコン定義 (変更なし) ===
        const icons = { /* ... 省略 ... */ };

        // ▼▼▼ 変更点: stateの構造をパーティー管理用に変更 ▼▼▼
        let state = {
            parties: {},
            itemTemplates: [],
            currentPartyId: null,
            selectedCharacterId: null,
            sort: { key: 'name', order: 'asc' },
            theme: 'dark',
            // --- モーダル表示状態 ---
            showCharacterModal: false,
            showItemModal: false,
            showMoveModal: false,
            showTemplateModal: false,
            showEditCharacterModal: false,
            showPartyModal: false,
            // --- フォームデータ ---
            moveItemData: { item: null, quantity: 1 },
            characterForm: { name: '', maxWeight: 0 },
            itemForm: { name: '', weight: 0, quantity: 1, sellPrice: 0, type: '武器' },
            templateForm: { name: '', weight: 0, sellPrice: 0, type: '武器' },
            partyForm: { name: '' },
            // --- 編集状態 ---
            editingCharacterId: null,
            editCharacterForm: { maxWeight: 0 },
            editingItemField: { id: null, field: null },
            draggingCharacterId: null,
            editingSharedMoney: false,
        };

        const appContainer = document.getElementById('app');
        
        // ▼▼▼ 追加: 現在選択中のパーティーデータを取得するヘルパー関数 ▼▼▼
        const getCurrentParty = () => state.parties[state.currentPartyId] || null;

        // ▼▼▼ 変更点: データ保存・読み込み処理をパーティー構造に対応 ▼▼▼
        function updateFirebase() {
            const dataToSave = {
                parties: state.parties,
                itemTemplates: state.itemTemplates,
            };
            database.ref().set(dataToSave);
        }

        function setupDataListener() {
            database.ref().on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) { // データが何もない場合
                    render();
                    return;
                }

                // データ移行処理: 古いデータ構造を検知したら新しい形式に変換
                if (data.characters && !data.parties) {
                    console.log("古いデータ構造を検知しました。新しいパーティー形式に移行します。");
                    const newPartyId = Date.now();
                    const newParty = {
                        id: newPartyId,
                        name: "デフォルトパーティー",
                        characters: data.characters || [],
                        sharedAssets: data.sharedAssets || { money: 0 },
                        logs: data.logs || [],
                    };
                    state.parties[newPartyId] = newParty;
                    state.itemTemplates = data.itemTemplates || [];
                    state.currentPartyId = newPartyId;
                    
                    // 古いデータを削除して新しいデータ構造で保存
                    database.ref('characters').remove();
                    database.ref('sharedAssets').remove();
                    database.ref('logs').remove();
                    updateFirebase();
                    alert("既存のデータは「デフォルトパーティー」として保存されました。");
                    return;
                }

                state.parties = data.parties || {};
                state.itemTemplates = data.itemTemplates || [];

                // 最後に選択したパーティーを復元、なければ最初のパーティーを選択
                const lastPartyId = localStorage.getItem('arianrod-lastPartyId');
                if (lastPartyId && state.parties[lastPartyId]) {
                    state.currentPartyId = lastPartyId;
                } else if (Object.keys(state.parties).length > 0) {
                    state.currentPartyId = Object.keys(state.parties)[0];
                } else {
                    state.currentPartyId = null;
                }
                
                if (state.currentPartyId) {
                    const party = getCurrentParty();
                    if (state.selectedCharacterId && !party.characters.find(c => c.id === state.selectedCharacterId)) {
                        state.selectedCharacterId = null;
                    }
                }

                render();
            });
        }
        
        // ▼▼▼ 追加: パーティー関連のイベントハンドラ ▼▼▼
        function handleSelectParty(partyId) {
            state.currentPartyId = partyId;
            state.selectedCharacterId = null; // パーティーを切り替えたらキャラクター選択をリセット
            localStorage.setItem('arianrod-lastPartyId', partyId);
            render();
        }

        function handleAddParty() {
            const name = state.partyForm.name.trim();
            if (!name) {
                alert('パーティー名を入力してください。');
                return;
            }
            const newPartyId = Date.now();
            const newParty = {
                id: newPartyId,
                name: name,
                characters: [],
                sharedAssets: { money: 0 },
                logs: [],
            };
            state.parties[newPartyId] = newParty;
            state.currentPartyId = newPartyId; // 作成したパーティーをすぐに選択
            localStorage.setItem('arianrod-lastPartyId', newPartyId);
            state.showPartyModal = false;
            state.partyForm.name = '';
            updateFirebase();
        }

        function handleDeleteParty(partyId) {
             const party = state.parties[partyId];
             if (!party || !window.confirm(`「${party.name}」を削除しますか？\nこのパーティーに所属する全キャラクターと共有財産、ログが完全に削除されます。この操作は元に戻せません。`)) {
                 return;
             }
             delete state.parties[partyId];
             
             // もし削除したのが現在選択中のパーティーなら、選択を解除
             if(state.currentPartyId == partyId) {
                 state.currentPartyId = null;
                 state.selectedCharacterId = null;
                 localStorage.removeItem('arianrod-lastPartyId');
             }
             updateFirebase();
        }


        // ▼▼▼ 変更点: 既存の関数をパーティーデータに対応させる ▼▼▼
        // 各関数内で `state.characters` 等を直接参照するのではなく、
        // `getCurrentParty()` を経由して現在のパーティーのデータを参照するように変更

        const addLog = (message) => {
            const party = getCurrentParty();
            if (!party) return;
            const timestamp = new Date().toLocaleString('ja-JP');
            const newLog = { id: Date.now(), timestamp, message };
            if (!party.logs) party.logs = [];
            party.logs.unshift(newLog);
        };

        const calculateCurrentWeight = (character) => { /* 変更なし */ return 0; };
        
        const getSelectedCharacter = () => {
            const party = getCurrentParty();
            if (!party || !party.characters) return null;
            return party.characters.find(c => c.id === state.selectedCharacterId);
        };
        
        function handleAddCharacter() {
            const party = getCurrentParty();
            if (!party) return;
            // ... (処理はほぼ同じ、party.characters に追加する)
            const { name, maxWeight } = state.characterForm;
            if (name.trim() === '' || maxWeight <= 0) { alert('名前と携帯可能重量を正しく入力してください。'); return; }
            const newCharacter = { id: Date.now(), name: name, maxWeight: Number(maxWeight), items: [], hasWeaponCase: false, hasPotionHolder: false, hasLunchBox: false, hasToolPouch: false, hasQuiver: false, };
            if (!party.characters) party.characters = [];
            party.characters.push(newCharacter);
            if (!state.selectedCharacterId) { state.selectedCharacterId = newCharacter.id; }
            addLog(`${newCharacter.name}がパーティに参加しました。`);
            state.characterForm = { name: '', maxWeight: 0 };
            state.showCharacterModal = false;
            updateFirebase();
        }

        // --- handleUpdateCharacterWeight, handleDeleteCharacter, etc. ---
        // 他のすべてのデータ操作関数も同様に、関数の最初に `const party = getCurrentParty(); if (!party) return;`
        // を追加し、`state.characters` や `state.sharedAssets` を `party.characters` や `party.sharedAssets` に書き換える必要があります。
        // (以下、主要な関数のみ修正例を記載)

        function handleDrop(targetCharacterId, event) {
            const party = getCurrentParty();
            if (!party) return;
            event.preventDefault();
            const draggedId = state.draggingCharacterId;
            if (draggedId === targetCharacterId) return;
            const draggedItem = party.characters.find(c => c.id === draggedId);
            const remainingItems = party.characters.filter(c => c.id !== draggedId);
            const targetIndex = remainingItems.findIndex(c => c.id === targetCharacterId);
            remainingItems.splice(targetIndex, 0, draggedItem);
            party.characters = remainingItems; // ここを変更
            const targetElement = event.target.closest('[draggable="true"]');
            if (targetElement) targetElement.classList.remove('drag-over');
            state.draggingCharacterId = null;
            updateFirebase();
        }

        function handleSellItem(itemId) {
            const party = getCurrentParty();
            const selectedCharacter = getSelectedCharacter();
            if (!party || !selectedCharacter) return;
            const item = selectedCharacter.items.find(i => i.id === itemId);
            if (!item) return;
            const totalSellValue = Number(item.sellPrice) * Number(item.quantity);
            if (window.confirm(`${item.name}(${item.quantity}個) を合計 ${totalSellValue}G で売却しますか？`)) {
                const oldMoney = party.sharedAssets.money || 0;
                party.sharedAssets.money = oldMoney + totalSellValue; // ここを変更
                selectedCharacter.items = selectedCharacter.items.filter(i => i.id !== itemId);
                addLog(`${selectedCharacter.name} が ${item.name}(${item.quantity}個) を売却し、共有財産が ${totalSellValue}G 増えました。`);
                updateFirebase();
            }
        }
        
        function handleUpdateSharedMoney(newMoneyStr) {
            const party = getCurrentParty();
            if (!party) return;
            const newMoney = Number(Math.floor(newMoneyStr));
            if (isNaN(newMoney) || newMoney < 0) { state.editingSharedMoney = false; render(); return; }
            if (party.sharedAssets.money !== newMoney) {
                addLog(`共有財産が ${party.sharedAssets.money}G から ${newMoney}G に変更されました。`);
                party.sharedAssets.money = newMoney; // ここを変更
            }
            state.editingSharedMoney = false;
            updateFirebase();
        }
        
        function handleMoveItem(targetCharacterId) {
            const party = getCurrentParty();
            if (!party) return;
            const sourceCharacter = getSelectedCharacter();
            const targetCharacter = party.characters.find(c => c.id === targetCharacterId);
            // ... (以下、同様にparty.characters基準で処理)
        }

        // (他の多くの関数も同様の修正が必要です。ここでは主要な部分のみ示しています。)
        // 全ての関数を修正したコードを render 関数以下に記述します。


        // === UI描画関数 ===
        function render() {
            document.body.className = `theme-${state.theme}`;
            const party = getCurrentParty();
            
            appContainer.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h1 class="text-4xl md:text-5xl font-bold text-center text-title" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">
                            アイテム管理ツール
                        </h1>
                        <div class="flex items-center gap-2">
                            <!-- ▼▼▼ 追加: パーティー選択UI ▼▼▼ -->
                            <div class="flex items-center gap-2 bg-black/10 p-2 rounded-lg">
                                <select onchange="handleSelectParty(this.value)" class="input-bg rounded px-3 py-2 text-lg">
                                    ${Object.keys(state.parties).length === 0 ? '<option>パーティーなし</option>' : ''}
                                    ${Object.values(state.parties).map(p => `<option value="${p.id}" ${p.id == state.currentPartyId ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                                <button onclick="state.showPartyModal = true; render()" class="btn btn-secondary text-white px-3 py-2 rounded-md flex items-center gap-1 text-base"> ${icons.plus} 新規</button>
                                ${party ? `<button onclick="handleDeleteParty(${party.id})" class="text-red-500 hover:text-red-700 p-2 rounded-full hover-bg transition-colors" title="現在のパーティーを削除">${icons.trash}</button>` : ''}
                            </div>
                            <button onclick="handleToggleTheme(); render()" class="btn bg-gray-500/10 hover:bg-gray-500/20 text-sm px-4 py-2 rounded-lg text-body">
                                ${state.theme === 'dark' ? 'ライト' : 'ダーク'}
                            </button>
                        </div>
                    </div>

                    ${!party ? `
                        <div class="text-center card-bg rounded-lg shadow-lg p-12">
                            <h2 class="text-3xl font-semibold text-title mb-4">ようこそ！</h2>
                            <p class="text-muted text-xl mb-6">管理するパーティーが選択されていません。<br>新しいパーティーを作成して始めましょう。</p>
                            <button onclick="state.showPartyModal = true; render()" class="btn btn-secondary text-white px-6 py-3 rounded-md flex items-center gap-2 text-xl mx-auto"> ${icons.plus} 新しいパーティーを作成 </button>
                        </div>
                    ` : (() => {
                        // ▼▼▼ 変更点: ここからは party 変数を使って描画する ▼▼▼
                        const selectedCharacter = getSelectedCharacter();
                        const currentWeight = selectedCharacter ? calculateCurrentWeight(selectedCharacter) : 0;
                        const isOverWeight = selectedCharacter ? currentWeight > selectedCharacter.maxWeight : false;

                        let sortedItems = [];
                        if (selectedCharacter && selectedCharacter.items) {
                            sortedItems = [...selectedCharacter.items].sort((a, b) => { /* ソートロジックは変更なし */ return 0; });
                        }

                        return `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <div>
                                <div class="card-bg rounded-lg shadow-lg p-6 mb-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-2xl font-semibold text-title">キャラクター一覧</h2>
                                        <button onclick="state.showCharacterModal = true; render();" class="btn btn-secondary text-white px-3 py-1 rounded-md flex items-center gap-1 text-base"> ${icons.plus} 追加 </button>
                                    </div>
                                    <div class="space-y-2">
                                        ${ (party.characters || []).map(character => {
                                            const weight = calculateCurrentWeight(character);
                                            const isOver = weight > character.maxWeight;
                                            const isSelected = character.id === state.selectedCharacterId;
                                            // ... (キャラクター表示HTMLは変更なし)
                                            return `<div draggable="true" ...> ... </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                                <div class="card-bg rounded-lg shadow-lg p-6">
                                    <h2 class="text-2xl font-semibold mb-2 text-title">共有財産</h2>
                                    <div class="text-4xl font-bold text-gold">
                                        ${state.editingSharedMoney ? `<input ... onblur="handleUpdateSharedMoney(this.value)" ... value="${party.sharedAssets.money || 0}">` : `<span ...>${party.sharedAssets.money || 0} G</span>`}
                                    </div>
                                </div>
                            </div>
                            <div class="lg:col-span-2 card-bg rounded-lg shadow-lg p-6">
                                ${selectedCharacter ? `
                                    <!-- 所持品表示エリア (ロジックはほぼ変更なし) -->
                                ` : `<div class="text-center text-muted py-12 text-lg">キャラクターを選択してください</div>`}
                            </div>
                        </div>
                        <div class="card-bg rounded-lg shadow-lg p-6">
                            <h2 class="text-2xl font-semibold text-title">アクションログ</h2>
                            <div class="max-h-64 overflow-y-auto ...">
                                ${(!party.logs || party.logs.length === 0) ? `<p>まだログがありません</p>` : `... ${party.logs.map(log => `...`).join('')} ...`}
                            </div>
                        </div>
                        `;
                    })()}
                </div>
                ${renderModals()}
            `;
        }
        
        function renderModals() {
            let modalHTML = '';
            // ... (既存のモーダルはほぼ変更なし)

            // ▼▼▼ 追加: パーティー作成モーダル ▼▼▼
            if (state.showPartyModal) {
                modalHTML += `
                    <div class="modal-overlay">
                        <div class="card-bg p-6 rounded-lg w-96">
                            <h3 class="text-xl font-semibold mb-4 text-title">新しいパーティーを作成</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-base font-medium mb-1 text-muted">パーティー名</label>
                                    <input type="text" value="${state.partyForm.name}" oninput="state.partyForm.name = this.value" class="w-full input-bg rounded px-3 py-2" placeholder="例：太陽の騎士団">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2 mt-6">
                                <button onclick="state.showPartyModal = false; state.partyForm.name = ''; render();" class="btn px-4 py-2 bg-stone-700 hover:bg-stone-600 rounded text-base">キャンセル</button>
                                <button onclick="handleAddParty()" class="btn px-4 py-2 btn-secondary text-white rounded text-base">作成</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            return modalHTML;
        }

        // === アプリケーションの初期化 ===
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('arianrod-theme') || 'dark';
            state.theme = savedTheme;
            setupDataListener();
        });
        
        // (省略した関数群の完全な実装をここに追加する必要があります)
        // ここではコンセプトを伝えるため、主要な修正点のみを記載しました。
        // 実際の動作には、省略したすべての `handle...` 関数を `getCurrentParty()` を使うように修正する必要があります。
    </script>
</body>
</html>

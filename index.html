<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アリアンロッド2e アイテム管理ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Merriweather&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Merriweather', serif; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Cinzel Decorative', serif; letter-spacing: 0.1em; }
        /* --- (スタイル定義は変更がないため省略) --- */
        .theme-light, .theme-light html { background-color: #f0f9ff; color: #1f2937; }
        .theme-light .card-bg { background-color: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .theme-light .text-title { color: #1e40af; }
        .theme-light .text-body { color: #1f2937; }
        .theme-light .text-muted { color: #6b7280; }
        .theme-light .text-gold { color: #eab308; }
        .theme-light .border-color { border-color: #e5e7eb; }
        .theme-light .hover-bg:hover { background-color: #f3f4f6; }
        .theme-light .btn { border-color: rgba(0,0,0,0.1); }
        .theme-light .btn:hover { border-color: rgba(0,0,0,0.2); }
        .theme-light .btn-primary { background-color: #3b82f6; color: white; }
        .theme-light .btn-primary:hover { background-color: #2563eb; }
        .theme-light .btn-secondary { background-color: #84cc16; color: white; }
        .theme-light .btn-secondary:hover { background-color: #65a30d; }
        .theme-light .input-bg { background-color: white; border-color: #d1d5db; color: #1f2937; }
        .theme-light .input-bg:focus { border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; outline:none; }
        .theme-light .selected-row { background-color: #eff6ff; }
        .theme-dark, .theme-dark html { background-color: #171717; }
        .theme-dark { background-image: url('https://images.unsplash.com/photo-1549317336-206569e8ad8f?q=80&w=2574&auto=format&fit=crop'); background-size: cover; background-position: center; background-attachment: fixed; color: #e5e7eb; }
        .theme-dark .card-bg { background-color: rgba(23, 23, 23, 0.85); backdrop-filter: blur(5px); border: 1px solid rgba(212, 175, 55, 0.3); }
        .theme-dark .text-title { color: #fcd34d; }
        .theme-dark .text-body { color: #e5e7eb; }
        .theme-dark .text-muted { color: #9ca3af; }
        .theme-dark .text-gold { color: #fbbf24; }
        .theme-dark .border-color { border-color: rgba(212, 175, 55, 0.2); }
        .theme-dark .hover-bg:hover { background-color: rgba(255,255,255,0.1); }
        .theme-dark .btn { border-color: rgba(212, 175, 55, 0.6); }
        .theme-dark .btn:hover { border-color: rgba(222, 185, 65, 0.9); }
        .theme-dark .btn-primary { background-color: #0369a1; color: white; }
        .theme-dark .btn-primary:hover { background-color: #0284c7; }
        .theme-dark .btn-secondary { background-color: #059669; color: white; }
        .theme-dark .btn-secondary:hover { background-color: #10b981; }
        .theme-dark .input-bg { background-color: rgba(0,0,0,0.3); border-color: rgba(212, 175, 55, 0.3); color: #e5e7eb; }
        .theme-dark .input-bg:focus { border-color: #fcd34d; outline:none; }
        .theme-dark .selected-row { background-color: rgba(251, 191, 36, 0.15); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .dragging { opacity: 0.5; }
        .drag-over { border-top: 2px solid #FFD700; }
        #toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 1rem; border-radius: 0.5rem; color: white; opacity: 0; transform: translateX(100%); transition: all 0.3s ease-in-out; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background-color: #22c55e; } .toast-error { background-color: #ef4444; } .toast-info { background-color: #3b82f6; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-2 md:p-4"></div>
    <div id="toast-container"></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCXuo4QVfhbpkrkRUo1-blKsNamtvD6vQU", authDomain: "ariannrod2e-manegiment.firebaseapp.com", databaseURL: "https://ariannrod2e-manegiment-default-rtdb.firebaseio.com", projectId: "ariannrod2e-manegiment", storageBucket: "ariannrod2e-manegiment.firebasestorage.app", messagingSenderId: "1085477870210", appId: "1:1085477870210:web:cf443812d635516784329b", measurementId: "G-172C1B7JEF" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const icons = { plus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`, trash: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`, arrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>`, edit: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`, grip: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 cursor-move"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>`, coin: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="8"></line></svg>`, use: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21h8"/><path d="M12 11v10"/><path d="m19 5-7 7-7-7"/></svg>`, book: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`, logOut: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`, lock: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`, settings: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>` };

        let state = {
            partyId: null, partyName: '', partyList: [], showPartyCreateModal: false, showPartySettingsModal: false,
            partyCreateForm: { name: '', password: '' }, partySettingsForm: { name: '', password: '' },
            password: '', characters: [], sharedAssets: { money: 0 }, sharedStorage: [], itemTemplates: [], selectedCharacterId: null, logs: [],
            sort: { key: 'name', order: 'asc' }, theme: 'dark', showCharacterModal: false, showItemModal: false, showMoveModal: false, showTemplateModal: false,
            moveItemData: { item: null, quantity: 1, source: '' }, characterForm: { name: '', maxWeight: 0, memo: '' },
            itemForm: { name: '', weight: 0, quantity: 1, sellPrice: 0, type: '武器', memo: '' },
            editingCharacterMemoId: null, editingItemField: { id: null, field: null, source: null }, draggingCharacterId: null, editingSharedMoney: false,
        };
        const appContainer = document.getElementById('app');
        const toastContainer = document.getElementById('toast-container');

        function getPartyRef() { if (!state.partyId) return null; return database.ref('parties/' + state.partyId); }
        function updateFirebase() { const partyRef = getPartyRef(); if (!partyRef) return; const dataToSave = { characters: state.characters, sharedAssets: state.sharedAssets, sharedStorage: state.sharedStorage, logs: state.logs, itemTemplates: state.itemTemplates }; partyRef.update(dataToSave); }
        function setupDataListener() { const partyRef = getPartyRef(); if (!partyRef) return; partyRef.on('value', (snapshot) => { const data = snapshot.val(); if (data) { state.password = data.password; state.characters = data.characters || []; state.sharedAssets = data.sharedAssets || { money: 0 }; state.sharedStorage = data.sharedStorage || []; state.logs = data.logs || []; state.itemTemplates = data.itemTemplates || []; if (state.selectedCharacterId && !state.characters.find(c => c.id === state.selectedCharacterId)) { state.selectedCharacterId = null; } database.ref('party_meta/' + state.partyId + '/name').once('value', nameSnap => { state.partyName = nameSnap.val() || ''; render(); }); } else { window.location.hash = ''; } }); }

        function showToast(message, type = 'info') { const toast = document.createElement('div'); toast.className = `toast toast-${type}`; toast.textContent = message; toastContainer.appendChild(toast); setTimeout(() => { toast.classList.add('show'); }, 10); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 3000); }
        const addLog = (message) => { const timestamp = new Date().toLocaleString('ja-JP'); const newLog = { id: Date.now(), timestamp, message }; if (!state.logs) state.logs = []; state.logs.unshift(newLog); };
        
        const calculateCurrentWeight = (character) => { if (!character || !character.items) return 0; let totalWeight = 0; const heaviestWeapon = character.hasWeaponCase ? character.items.filter(item => item.type === '武器').sort((a, b) => b.weight - a.weight)[0] : null; if (character.hasPotionHolder) { const totalPotionCount = character.items.filter(item => item.type === 'ポーション' && item.weight === 1).reduce((sum, item) => sum + item.quantity, 0); totalWeight += Math.max(0, totalPotionCount - 5); } if (character.hasLunchBox) { const foodItems = character.items.filter(item => item.type === '食料'); const sortedFood = [...foodItems].sort((a, b) => b.weight - a.weight); let freeItemsBudget = 5; sortedFood.forEach(foodItem => { if (freeItemsBudget <= 0) { totalWeight += foodItem.weight * foodItem.quantity; } else { const itemsToMakeFree = Math.min(foodItem.quantity, freeItemsBudget); totalWeight += (foodItem.quantity - itemsToMakeFree) * foodItem.weight; freeItemsBudget -= itemsToMakeFree; } }); } character.items.forEach(item => { if (character.hasPotionHolder && item.type === 'ポーション' && item.weight === 1) return; if (character.hasLunchBox && item.type === '食料') return; let itemWeight = item.weight * item.quantity; if (character.hasToolPouch && item.type === '道具' && item.weight === 1) { itemWeight = (item.quantity - Math.min(item.quantity, 5)) * item.weight; } else if (character.hasQuiver && item.type === '矢弾' && item.weight === 1) { itemWeight = (item.quantity - Math.min(item.quantity, 5)) * item.weight; } else if (heaviestWeapon && item.id === heaviestWeapon.id) { itemWeight = Math.max(0, item.quantity - 1) * item.weight; } totalWeight += itemWeight; }); return totalWeight; };
        const getSelectedCharacter = () => { if (!state.characters) return null; return state.characters.find(c => c.id === state.selectedCharacterId); };
        
        function handleAddCharacter() { const { name, maxWeight, memo } = state.characterForm; if (name.trim() === '' || maxWeight <= 0) { showToast('名前と携帯可能重量を正しく入力してください。', 'error'); return; } const newCharacter = { id: Date.now(), name: name, maxWeight: Number(maxWeight), items: [], memo: memo || '', hasWeaponCase: false, hasPotionHolder: false, hasLunchBox: false, hasToolPouch: false, hasQuiver: false, }; if (!state.characters) state.characters = []; state.characters.push(newCharacter); if (!state.selectedCharacterId) { state.selectedCharacterId = newCharacter.id; } addLog(`${newCharacter.name}がパーティに参加しました。`); state.characterForm = { name: '', maxWeight: 0, memo: '' }; state.showCharacterModal = false; updateFirebase(); showToast(`${name}を追加しました。`, 'success'); }
        function handleAddItem(target = 'character') { const { name, weight, quantity, sellPrice, type, memo } = state.itemForm; if (name.trim() === '') { showToast('アイテム名を入力してください。', 'error'); return; } const newItem = { id: Date.now(), name, weight: Number(weight), quantity: Number(quantity), sellPrice: Number(sellPrice), type, memo: memo || '' }; if (target === 'storage') { if (!state.sharedStorage) state.sharedStorage = []; state.sharedStorage.push(newItem); addLog(`共有倉庫に${newItem.name}(${newItem.quantity}個)が追加されました。`); } else { const selectedCharacter = getSelectedCharacter(); if (!selectedCharacter) return; if (!selectedCharacter.items) selectedCharacter.items = []; selectedCharacter.items.push(newItem); addLog(`${selectedCharacter.name}が${newItem.name}(${newItem.quantity}個)を獲得しました。`); } state.itemForm = { name: '', weight: 0, quantity: 1, sellPrice: 0, type: '武器', memo: '' }; state.showItemModal = false; updateFirebase(); showToast(`${name}を追加しました。`, 'success'); }
        function handleUpdateCharacterMemo(characterId, memo) { const character = state.characters.find(c => c.id === characterId); if (character) { character.memo = memo; state.editingCharacterMemoId = null; updateFirebase(); } }
        function handleDeleteCharacter(characterId, event) { event.stopPropagation(); const characterToDelete = state.characters.find(c => c.id === characterId); if (!characterToDelete) return; if (window.confirm(`${characterToDelete.name} を削除しますか？\nこのキャラクターが所持しているアイテムも全て削除されます。`)) { const characterName = characterToDelete.name; state.characters = state.characters.filter(c => c.id !== characterId); addLog(`${characterName} がパーティから離脱しました。`); updateFirebase(); showToast(`${characterName}を削除しました。`, 'info'); } }
        
        // ▼▼▼ 変更点1: handleUpdateItemFieldを大幅に強化 ▼▼▼
        function handleUpdateItemField(itemId, field, value, source = 'character') {
            const itemSource = source === 'storage' ? state.sharedStorage : getSelectedCharacter()?.items;
            const item = itemSource?.find(i => i.id === itemId);
            if (!item) return;

            let newValue = value;
            switch(field) {
                case 'weight':
                case 'quantity':
                case 'sellPrice':
                    newValue = Number(Math.floor(value));
                    if(isNaN(newValue) || newValue < 0) {
                        showToast('無効な数値です。', 'error');
                        state.editingItemField = { id: null, field: null, source: null };
                        render();
                        return;
                    }
                    break;
            }

            if (item[field] !== newValue) {
                item[field] = newValue;
                updateFirebase();
            }
            state.editingItemField = { id: null, field: null, source: null };
            render();
        }
        // ▲▲▲ 変更ここまで ▲▲▲

        function handleDeleteItem(itemId, source = 'character') { const itemName = (source === 'storage' ? state.sharedStorage.find(i=>i.id === itemId) : getSelectedCharacter()?.items.find(i=>i.id===itemId))?.name; if (!window.confirm(`${itemName}を削除(破棄)しますか？この操作では共有財産は増えません。`)) return; if (source === 'storage') { state.sharedStorage = state.sharedStorage.filter(i => i.id !== itemId); addLog(`共有倉庫から${itemName}を破棄しました。`); } else { const selectedCharacter = getSelectedCharacter(); selectedCharacter.items = selectedCharacter.items.filter(i => i.id !== itemId); addLog(`${selectedCharacter.name}が${itemName}を破棄しました。`); } updateFirebase(); showToast(`${itemName}を削除しました。`, 'info'); }
        function handleSellItem(itemId, source = 'character') { const itemSource = source === 'storage' ? state.sharedStorage : getSelectedCharacter()?.items; const item = itemSource?.find(i => i.id === itemId); if (!item) return; const totalSellValue = Number(item.sellPrice) * Number(item.quantity); if (window.confirm(`${item.name}(${item.quantity}個) を合計 ${totalSellValue}G で売却しますか？`)) { const oldMoney = state.sharedAssets.money || 0; state.sharedAssets.money = oldMoney + totalSellValue; if (source === 'storage') { state.sharedStorage = state.sharedStorage.filter(i => i.id !== item.id); addLog(`共有倉庫の${item.name}(${item.quantity}個)を売却し、共有財産が${totalSellValue}G増えました。`); } else { const selectedCharacter = getSelectedCharacter(); selectedCharacter.items = selectedCharacter.items.filter(i => i.id !== item.id); addLog(`${selectedCharacter.name}が${item.name}(${item.quantity}個)を売却し、共有財産が${totalSellValue}G増えました。`); } updateFirebase(); showToast(`${item.name}を売却しました。`, 'success'); } }
        function handleMoveItem(targetCharacterId) { const { item, quantity, source } = state.moveItemData; const quantityToMove = Number(Math.floor(quantity)); if (isNaN(quantityToMove) || quantityToMove < 1) { showToast("1以上の有効な数値を入力してください。", 'error'); return; } if (quantityToMove > item.quantity) { showToast(`移動できるのは最大 ${item.quantity}個までです。`, 'error'); return; } let sourceCharacterName = ''; let sourceItems = null; if (source === 'storage') { sourceCharacterName = '共有倉庫'; sourceItems = state.sharedStorage; } else { sourceCharacterName = state.characters.find(c => c.id === source)?.name; sourceItems = state.characters.find(c => c.id === source)?.items; } const sourceItem = sourceItems?.find(i => i.id === item.id); if (!sourceItem) return; let targetName = ''; let targetItems = null; if (targetCharacterId === 'storage') { targetName = '共有倉庫'; targetItems = state.sharedStorage; if (!targetItems) { state.sharedStorage = []; targetItems = state.sharedStorage; } } else { const targetCharacter = state.characters.find(c => c.id === targetCharacterId); targetName = targetCharacter.name; if (!targetCharacter.items) targetCharacter.items = []; targetItems = targetCharacter.items; } const targetItem = targetItems.find(i => i.name === sourceItem.name && i.weight === sourceItem.weight && i.sellPrice === sourceItem.sellPrice && i.type === sourceItem.type); if (targetItem) { targetItem.quantity += quantityToMove; } else { targetItems.push({ ...sourceItem, id: Date.now(), quantity: quantityToMove }); } sourceItem.quantity -= quantityToMove; if (sourceItem.quantity <= 0) { if (source === 'storage') { state.sharedStorage = sourceItems.filter(i => i.id !== sourceItem.id); } else { const sourceCharacter = state.characters.find(c => c.id === source); sourceCharacter.items = sourceItems.filter(i => i.id !== sourceItem.id); } } addLog(`${sourceCharacterName}が「${sourceItem.name}」を ${quantityToMove}個、${targetName}に渡しました。`); state.showMoveModal = false; updateFirebase(); showToast('アイテムを移動しました。', 'success'); }
        function handleUpdatePartySettings() { const { name, password } = state.partySettingsForm; if (name.trim() === '') { showToast('パーティー名は空にできません。', 'error'); return; } const partyId = state.partyId; database.ref('party_meta/' + partyId).update({ name: name, hasPassword: !!password }); database.ref('parties/' + partyId).update({ password: password }); state.showPartySettingsModal = false; showToast('パーティー設定を更新しました。', 'success'); }
        function handleConfirmCreateParty() { const { name, password } = state.partyCreateForm; if (name.trim() === '') { showToast('パーティ名を入力してください。', 'error'); return; } const newPartyId = 'p' + Date.now().toString(36) + Math.random().toString(36).substring(2, 7); const partyMetaRef = database.ref('party_meta/' + newPartyId); const partyDataRef = database.ref('parties/' + newPartyId); const initialPartyData = { characters: [], sharedAssets: { money: 0 }, sharedStorage: [], logs: [], itemTemplates: [], password: password || '' }; const partyMetaData = { name: name, hasPassword: !!password }; partyDataRef.set(initialPartyData).then(() => { partyMetaRef.set(partyMetaData).then(() => { state.partyCreateForm = { name: '', password: '' }; state.showPartyCreateModal = false; window.location.hash = newPartyId; }); }); }
        function handleJoinParty(partyId, meta) { if (meta.hasPassword) { const inputPassword = prompt(`「${meta.name}」に参加するにはパスワードが必要です:\nパスワードを入力してください`); if (inputPassword === null) return; database.ref('parties/' + partyId + '/password').once('value', snapshot => { const correctPassword = snapshot.val(); if (inputPassword === correctPassword) { window.location.hash = partyId; } else { showToast('パスワードが違います。', 'error'); } }); } else { window.location.hash = partyId; } }
        function handleLeaveParty() { if (window.confirm('現在のパーティから退出しますか？\n最初の画面に戻ります。')) { window.location.hash = ''; } }
        function handleDeleteParty() { const partyId = state.partyId; if (!partyId) return; if (window.confirm('本当にこのパーティーを削除しますか？\n全てのデータが失われ、この操作は元に戻せません。')) { const partyDataRef = database.ref('parties/' + partyId); const partyMetaRef = database.ref('party_meta/' + partyId); Promise.all([ partyDataRef.remove(), partyMetaRef.remove() ]).then(() => { showToast('パーティーを削除しました。', 'info'); window.location.hash = ''; }).catch(error => { console.error("パーティーの削除に失敗しました:", error); showToast('エラーによりパーティーの削除に失敗しました。', 'error'); }); } }
        function openMoveItemModal(item, source) { state.moveItemData = { item: JSON.parse(JSON.stringify(item)), quantity: 1, source: source }; state.showMoveModal = true; render(); }
        function handleUseItem(itemId, source = 'character') { const itemSource = source === 'storage' ? state.sharedStorage : getSelectedCharacter()?.items; const item = itemSource?.find(i => i.id === itemId); if (!item) return; const sourceName = source === 'storage' ? '共有倉庫' : getSelectedCharacter().name; const amountToUse = 1; if (item.quantity < amountToUse) { showToast('アイテムが足りません。', 'error'); return; } item.quantity -= amountToUse; addLog(`${sourceName}が「${item.name}」を${amountToUse}個使用しました。`); if (item.quantity <= 0) { if (source === 'storage') { state.sharedStorage = itemSource.filter(i => i.id !== itemId); } else { getSelectedCharacter().items = itemSource.filter(i => i.id !== itemId); } addLog(`「${item.name}」を使い切りました。`); } updateFirebase(); showToast(`${item.name}を使用しました。`, 'info'); }
        function handleToggleHolder(holderType) { const selectedCharacter = getSelectedCharacter(); if (!selectedCharacter) return; selectedCharacter[holderType] = !selectedCharacter[holderType]; updateFirebase(); render(); }
        
        function render() {
            document.body.className = `theme-${state.theme}`;
            if (!state.partyId) { appContainer.innerHTML = renderLobby() + renderModals(); return; }

            const selectedCharacter = getSelectedCharacter();
            const currentWeight = selectedCharacter ? calculateCurrentWeight(selectedCharacter) : 0;
            const isOverWeight = selectedCharacter ? currentWeight > selectedCharacter.maxWeight : false;
            
            const itemTypes = ['武器','ポーション','食料','道具','矢弾','その他'];

            appContainer.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-y-4">
                        <h1 class="text-4xl md:text-5xl font-bold text-title" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">${state.partyName || 'アイテム管理'}</h1>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button onclick="state.showPartySettingsModal = true; state.partySettingsForm.name = state.partyName; state.partySettingsForm.password = state.password; render();" class="btn bg-gray-500/10 hover:bg-gray-500/20 text-sm px-4 py-2 rounded-lg flex items-center gap-2" title="パーティー設定">${icons.settings} 設定</button>
                            <button onclick="handleLeaveParty()" class="btn ${state.theme === 'dark' ? 'bg-stone-700 hover:bg-stone-600' : 'bg-gray-200 hover:bg-gray-300'} text-sm px-4 py-2 rounded-lg flex items-center gap-2"> ${icons.logOut} パーティ退出</button>
                            <button onclick="handleToggleTheme(); render()" class="btn bg-gray-500/10 hover:bg-gray-500/20 text-sm px-4 py-2 rounded-lg text-body"> ${state.theme === 'dark' ? 'ライトテーマへ' : 'ダークテーマへ'} </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div>
                            <div class="card-bg rounded-lg shadow-lg p-6 mb-6">
                                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-title">キャラクター一覧</h2><button onclick="state.showCharacterModal = true; render();" class="btn btn-secondary text-white px-3 py-1 rounded-md flex items-center gap-1 text-base"> ${icons.plus} 追加 </button></div>
                                ${ (state.characters || []).map(character => {
                                    const isSelected = character.id === state.selectedCharacterId;
                                    return `<div onclick="state.selectedCharacterId = ${character.id}; render()" class="p-3 rounded-lg transition-all duration-200 border ${isSelected ? 'selected-row' : 'hover-bg'}">
                                        <div class="flex justify-between items-center"><div class="font-bold text-xl text-body">${character.name}</div><div class="flex items-center gap-1"><button onclick="handleDeleteCharacter(${character.id}, event)" class="text-red-500 hover:text-red-700 p-1 rounded-full hover-bg" title="${character.name}を削除"> ${icons.trash} </button></div></div>
                                        <div class="text-lg text-muted">${Math.floor(calculateCurrentWeight(character))} / ${Math.floor(character.maxWeight)}</div>
                                        ${ state.editingCharacterMemoId === character.id ? `<textarea class="w-full input-bg rounded p-1 mt-2 text-sm" onblur="handleUpdateCharacterMemo(${character.id}, this.value)" autofocus>${character.memo || ''}</textarea>` : `<p onclick="event.stopPropagation(); state.editingCharacterMemoId = ${character.id}; render();" class="text-sm text-muted mt-2 p-1 rounded hover-bg whitespace-pre-wrap min-h-[2rem]">${character.memo || 'メモを追加...'}</p>` }
                                    </div>`;
                                }).join('')}
                            </div>
                            <div class="card-bg rounded-lg shadow-lg p-6 mb-6">
                                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-title">共有倉庫</h2><button onclick="state.showItemModal = 'storage'; render();" class="btn btn-secondary text-white px-3 py-1 rounded-md flex items-center gap-1 text-base"> ${icons.plus} 追加 </button></div>
                                <div class="space-y-3 max-h-72 overflow-y-auto pr-2">${(state.sharedStorage || []).map(item => `
                                    <div class="p-2 rounded hover-bg border-b border-color">
                                        <div class="flex justify-between items-center">
                                            ${ state.editingItemField.id === item.id && state.editingItemField.source === 'storage' && state.editingItemField.field === 'name' ? `<input type="text" value="${item.name}" class="w-full input-bg rounded px-1" onblur="handleUpdateItemField(${item.id}, 'name', this.value, 'storage')" autofocus>` : `<div class="font-bold text-body" onclick="state.editingItemField={id:${item.id}, field:'name', source:'storage'}; render();">${item.name}</div>` }
                                            <div class="flex gap-1"><button onclick='openMoveItemModal(${JSON.stringify(item)}, "storage")' class="btn btn-primary text-white p-1 rounded text-xs" title="移動">${icons.arrowRight}</button><button onclick="handleDeleteItem(${item.id}, 'storage')" class="btn bg-rose-500 hover:bg-rose-600 text-white p-1 rounded text-xs" title="削除">${icons.trash}</button></div>
                                        </div>
                                        <div class="grid grid-cols-3 gap-2 text-sm mt-2">
                                            <div><span class="font-semibold text-muted">種類: </span>${ state.editingItemField.id === item.id && state.editingItemField.source === 'storage' && state.editingItemField.field === 'type' ? `<select class="w-full input-bg" onchange="handleUpdateItemField(${item.id}, 'type', this.value, 'storage')" autofocus>${itemTypes.map(o => `<option value="${o}" ${item.type === o ? 'selected' : ''}>${o}</option>`).join('')}</select>` : `<span class="hover-bg p-1 rounded" onclick="state.editingItemField={id:${item.id}, field:'type', source:'storage'}; render();">${item.type}</span>` }</div>
                                            <div><span class="font-semibold text-muted">個数: </span>${ state.editingItemField.id === item.id && state.editingItemField.source === 'storage' && state.editingItemField.field === 'quantity' ? `<input type="number" value="${item.quantity}" class="w-full input-bg text-right" onblur="handleUpdateItemField(${item.id}, 'quantity', this.value, 'storage')" autofocus>` : `<span class="hover-bg p-1 rounded" onclick="state.editingItemField={id:${item.id}, field:'quantity', source:'storage'}; render();">${item.quantity}</span>` }</div>
                                            <div><span class="font-semibold text-muted">重量: </span>${ state.editingItemField.id === item.id && state.editingItemField.source === 'storage' && state.editingItemField.field === 'weight' ? `<input type="number" value="${item.weight}" class="w-full input-bg text-right" onblur="handleUpdateItemField(${item.id}, 'weight', this.value, 'storage')" autofocus>` : `<span class="hover-bg p-1 rounded" onclick="state.editingItemField={id:${item.id}, field:'weight', source:'storage'}; render();">${item.weight}</span>` }</div>
                                        </div>
                                        <div class="text-sm mt-1"><span class="font-semibold text-muted">売却額: </span>${ state.editingItemField.id === item.id && state.editingItemField.source === 'storage' && state.editingItemField.field === 'sellPrice' ? `<input type="number" value="${item.sellPrice}" class="w-20 input-bg text-right" onblur="handleUpdateItemField(${item.id}, 'sellPrice', this.value, 'storage')" autofocus>` : `<span class="hover-bg p-1 rounded" onclick="state.editingItemField={id:${item.id}, field:'sellPrice', source:'storage'}; render();">${item.sellPrice}</span>` } G</div>
                                        ${ state.editingItemField.id === item.id && state.editingItemField.source === 'storage' && state.editingItemField.field === 'memo' ? `<textarea class="w-full input-bg rounded p-1 mt-1 text-sm" onblur="handleUpdateItemField(${item.id}, 'memo', this.value, 'storage')" autofocus>${item.memo || ''}</textarea>` : `<p onclick="state.editingItemField={id:${item.id}, field:'memo', source:'storage'}; render();" class="text-sm text-muted mt-1 p-1 rounded hover-bg whitespace-pre-wrap min-h-[1.8rem]">${item.memo || 'メモを追加...'}</p>` }
                                    </div>`).join('') || '<p class="text-center text-muted">倉庫は空です。</p>'}
                                </div>
                            </div>
                            <div class="card-bg rounded-lg shadow-lg p-6"><h2 class="text-2xl font-semibold mb-2 text-title">共有財産</h2><div class="text-4xl font-bold text-gold">${state.editingSharedMoney ? `<input type="number" value="${state.sharedAssets.money || 0}" class="w-full bg-transparent text-right border-b-2" onblur="handleUpdateSharedMoney(this.value)" onkeydown="if(event.key === 'Enter') this.blur();" autofocus>` : `<span onclick="state.editingSharedMoney = true; render();" class="cursor-pointer hover-bg px-2 py-1 rounded">${state.sharedAssets.money || 0} G</span>`}</div></div>
                        </div>
                        <div class="lg:col-span-2 card-bg rounded-lg shadow-lg p-6">
                            ${selectedCharacter ? `
                                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                    <div> <h2 class="text-3xl font-semibold text-title">${selectedCharacter.name}の所持品</h2> <p class="text-lg ${isOverWeight ? 'text-red-600 font-semibold' : 'text-muted'}"> 現在重量: ${Math.floor(currentWeight)} / ${Math.floor(selectedCharacter.maxWeight)} ${isOverWeight ? '(超過!)' : ''} </p> </div>
                                    <button onclick="state.showItemModal = 'character'; render();" class="btn btn-secondary text-white px-4 py-2 rounded-md flex items-center gap-2 text-base"> ${icons.plus} アイテム追加 </button>
                                </div>
                                <div class="mb-4 p-3 bg-black/5 rounded-lg border border-color"><h3 class="font-semibold mb-2 text-title text-lg">特殊アイテム</h3><div class="flex flex-wrap gap-2"><button onclick="handleToggleHolder('hasWeaponCase')" class="px-3 py-1 text-sm rounded-full text-white ${selectedCharacter.hasWeaponCase ? 'bg-indigo-500' : 'bg-gray-500'}">ウェポンケース</button><button onclick="handleToggleHolder('hasPotionHolder')" class="px-3 py-1 text-sm rounded-full text-white ${selectedCharacter.hasPotionHolder ? 'bg-sky-500' : 'bg-gray-500'}">ポーションホルダー</button><button onclick="handleToggleHolder('hasLunchBox')" class="px-3 py-1 text-sm rounded-full text-white ${selectedCharacter.hasLunchBox ? 'bg-amber-500' : 'bg-gray-500'}">ランチボックス</button><button onclick="handleToggleHolder('hasToolPouch')" class="px-3 py-1 text-sm rounded-full text-white ${selectedCharacter.hasToolPouch ? 'bg-teal-500' : 'bg-gray-500'}">小道具入れ</button><button onclick="handleToggleHolder('hasQuiver')" class="px-3 py-1 text-sm rounded-full text-white ${selectedCharacter.hasQuiver ? 'bg-orange-500' : 'bg-gray-500'}">矢筒</button></div></div>
                                <div class="hidden md:block overflow-x-auto">
                                    <table class="w-full border-collapse border-color text-base">
                                        <thead><tr class="bg-black/5">
                                            <th class="p-2 text-left font-bold text-title">アイテム名</th><th class="p-2 text-left font-bold text-title">種類</th><th class="p-2 text-right font-bold text-title">重量</th><th class="p-2 text-right font-bold text-title">個数</th><th class="p-2 text-right font-bold text-title">売却額</th><th class="p-2 text-left font-bold text-title">メモ</th><th class="p-2 text-center font-bold text-title">操作</th>
                                        </tr></thead>
                                        <tbody>${sortedItems.map(item => `
                                            <tr class="hover-bg">
                                                <td class="border-b border-color p-2">${ state.editingItemField.id === item.id && state.editingItemField.source === 'character' && state.editingItemField.field === 'name' ? `<input type="text" value="${item.name}" class="w-full input-bg" onblur="handleUpdateItemField(${item.id}, 'name', this.value, 'character')" autofocus>` : `<span class="p-1 block" onclick="state.editingItemField={id:${item.id}, field:'name', source:'character'}; render();">${item.name}</span>`}</td>
                                                <td class="border-b border-color p-2">${ state.editingItemField.id === item.id && state.editingItemField.source === 'character' && state.editingItemField.field === 'type' ? `<select class="w-full input-bg" onchange="handleUpdateItemField(${item.id}, 'type', this.value, 'character')" autofocus>${itemTypes.map(o => `<option value="${o}" ${item.type === o ? 'selected' : ''}>${o}</option>`).join('')}</select>` : `<span class="p-1 block" onclick="state.editingItemField={id:${item.id}, field:'type', source:'character'}; render();">${item.type}</span>`}</td>
                                                <td class="border-b border-color p-2 text-right">${ state.editingItemField.id === item.id && state.editingItemField.source === 'character' && state.editingItemField.field === 'weight' ? `<input type="number" value="${item.weight}" class="w-16 input-bg text-right" onblur="handleUpdateItemField(${item.id}, 'weight', this.value, 'character')" autofocus>` : `<span class="p-1 block" onclick="state.editingItemField={id:${item.id}, field:'weight', source:'character'}; render();">${item.weight}</span>`}</td>
                                                <td class="border-b border-color p-2 text-right">${ state.editingItemField.id === item.id && state.editingItemField.source === 'character' && state.editingItemField.field === 'quantity' ? `<input type="number" value="${item.quantity}" class="w-16 input-bg text-right" onblur="handleUpdateItemField(${item.id}, 'quantity', this.value, 'character')" autofocus>` : `<span class="p-1 block" onclick="state.editingItemField={id:${item.id}, field:'quantity', source:'character'}; render();">${item.quantity}</span>`}</td>
                                                <td class="border-b border-color p-2 text-right">${ state.editingItemField.id === item.id && state.editingItemField.source === 'character' && state.editingItemField.field === 'sellPrice' ? `<input type="number" value="${item.sellPrice}" class="w-20 input-bg text-right" onblur="handleUpdateItemField(${item.id}, 'sellPrice', this.value, 'character')" autofocus>` : `<span class="p-1 block" onclick="state.editingItemField={id:${item.id}, field:'sellPrice', source:'character'}; render();">${item.sellPrice} G</span>`}</td>
                                                <td class="border-b border-color p-2 text-sm text-muted whitespace-pre-wrap w-40">${ state.editingItemField.id === item.id && state.editingItemField.source === 'character' && state.editingItemField.field === 'memo' ? `<textarea class="w-full input-bg rounded p-1 text-xs" onblur="handleUpdateItemField(${item.id}, 'memo', this.value, 'character')" autofocus>${item.memo || ''}</textarea>` : `<div onclick="state.editingItemField={id:${item.id}, field:'memo', source:'character'}; render();" class="min-h-[2rem] p-1 rounded hover-bg">${item.memo || ''}</div>` }</td>
                                                <td class="border-b border-color p-2"><div class="flex gap-1 justify-center"><button onclick="handleUseItem(${item.id})" class="btn text-white p-1 rounded bg-lime-500 hover:bg-lime-600" title="使用">${icons.use}</button><button onclick="handleSellItem(${item.id})" class="btn text-white p-1 rounded bg-yellow-500 hover:bg-yellow-600" title="売却">${icons.coin}</button><button onclick='openMoveItemModal(${JSON.stringify(item)}, state.selectedCharacterId)' class="btn btn-primary text-white p-1 rounded" title="移動">${icons.arrowRight}</button><button onclick="handleDeleteItem(${item.id})" class="btn text-white p-1 rounded bg-rose-500 hover:bg-rose-600" title="削除">${icons.trash}</button></div></td>
                                            </tr>`).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `<div class="text-center text-muted py-12 text-lg">キャラクターを選択してください</div>`}
                        </div>
                    </div>
                    <div class="card-bg rounded-lg shadow-lg p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-title">アクションログ</h2>${(state.logs && state.logs.length > 0) ? `<button onclick="handleClearAllLogs()" class="btn bg-rose-500 hover:bg-rose-600 text-white px-3 py-1 rounded text-base flex items-center gap-1">${icons.trash} 全削除</button>` : ''}</div><div class="max-h-64 overflow-y-auto border border-color rounded p-4 bg-black/10">${(!state.logs || state.logs.length === 0) ? `<p class="text-center text-muted">まだログがありません</p>` : `<div class="space-y-1">${state.logs.map(log => `<div class="text-base flex justify-between items-center hover-bg px-2 py-1 rounded group"><div><span class="text-muted">${log.timestamp}</span><span class="mx-2 text-muted/50">|</span><span>${log.message}</span></div><button onclick="handleDeleteLog(${log.id})" class="opacity-0 group-hover:opacity-100 bg-red-500 hover:bg-red-600 text-white p-1 rounded" title="このログを削除">${icons.trash}</button></div>`).join('')}</div>`}</div></div>
                    <div class="mt-8 text-center"><button onclick="handleDeleteParty()" class="btn bg-red-500/80 hover:bg-red-500 text-white text-base px-4 py-2 rounded-lg flex items-center gap-2 mx-auto">${icons.trash} このパーティーを削除</button></div>
                </div>
                ${renderModals()}
            `;
        }
        
        function renderLobby() { const partyListHtml = state.partyList.map(party => `<button onclick='handleJoinParty("${party.id}", ${JSON.stringify(party.meta)})' class="w-full btn border-color text-left p-4 rounded-lg hover-bg flex justify-between items-center"> <span class="text-xl text-body">${party.meta.name}</span> ${party.meta.hasPassword ? `<span class="text-muted">${icons.lock}</span>` : ''} </button>`).join(''); return `<div class="flex items-center justify-center min-h-screen"> <div class="w-full max-w-lg mx-auto"> <div class="card-bg rounded-lg shadow-2xl p-8"> <h1 class="text-3xl md:text-4xl font-bold text-center text-title mb-8">アイテム管理ツール</h1> <div class="space-y-6"> <div> <button onclick="state.showPartyCreateModal = true; render();" class="w-full btn btn-secondary text-white rounded-lg py-3 text-lg font-bold flex items-center justify-center gap-2"> ${icons.plus} 新しいパーティを作成 </button> </div> <div> <h2 class="text-2xl font-semibold text-center text-title mb-4 border-b border-color pb-2">参加可能なパーティ</h2> <div class="space-y-3 max-h-64 overflow-y-auto pr-2"> ${state.partyList.length > 0 ? partyListHtml : '<p class="text-center text-muted py-4">現在、参加可能なパーティーはありません。</p>'} </div> </div> </div> </div> </div> </div>`; }
        
        function renderModals() {
            let modalHTML = '';
            if (state.showPartyCreateModal) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-96"> <h3 class="text-xl font-semibold mb-4 text-title">新しいパーティを作成</h3> <div class="space-y-4"> <div> <label class="block text-base font-medium mb-1">パーティ名</label> <input type="text" value="${state.partyCreateForm.name}" oninput="state.partyCreateForm.name = this.value" class="w-full input-bg rounded px-3 py-2"> </div> <div> <label class="block text-base font-medium mb-1">パスワード (任意)</label> <input type="password" value="${state.partyCreateForm.password}" oninput="state.partyCreateForm.password = this.value" class="w-full input-bg rounded px-3 py-2"> </div> </div> <div class="flex justify-end space-x-2 mt-6"> <button onclick="state.showPartyCreateModal = false; render();" class="btn">キャンセル</button> <button onclick="handleConfirmCreateParty()" class="btn btn-secondary text-white">作成</button> </div> </div> </div>`; }
            if (state.showPartySettingsModal) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-96"> <h3 class="text-xl font-semibold mb-4 text-title">パーティー設定</h3> <div class="space-y-4"> <div> <label class="block text-base font-medium mb-1">パーティ名</label> <input type="text" value="${state.partySettingsForm.name}" oninput="state.partySettingsForm.name = this.value" class="w-full input-bg rounded px-3 py-2"> </div> <div> <label class="block text-base font-medium mb-1">パスワード (空欄でパスワード解除)</label> <input type="password" value="${state.partySettingsForm.password}" oninput="state.partySettingsForm.password = this.value" class="w-full input-bg rounded px-3 py-2"> </div> </div> <div class="flex justify-end space-x-2 mt-6"> <button onclick="state.showPartySettingsModal = false; render();" class="btn">キャンセル</button> <button onclick="handleUpdatePartySettings()" class="btn btn-primary text-white">更新</button> </div> </div> </div>`; }
            if (state.showCharacterModal) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-96"> <h3 class="text-xl font-semibold mb-4">キャラクター追加</h3> <div class="space-y-4"> <div> <label class="block">キャラクター名</label> <input type="text" value="${state.characterForm.name}" oninput="state.characterForm.name = this.value" class="w-full input-bg rounded px-3 py-2"> </div> <div> <label class="block">携帯可能重量</label> <input type="number" min="0" value="${state.characterForm.maxWeight}" oninput="state.characterForm.maxWeight = Number(this.value)" class="w-full input-bg rounded px-3 py-2"> </div> <div> <label class="block">メモ</label> <textarea oninput="state.characterForm.memo = this.value" class="w-full input-bg rounded px-3 py-2">${state.characterForm.memo}</textarea> </div> </div> <div class="flex justify-end space-x-2 mt-6"> <button onclick="state.showCharacterModal = false; render();" class="btn">キャンセル</button> <button onclick="handleAddCharacter()" class="btn btn-secondary text-white">追加</button> </div> </div> </div>`; }
            if (state.showItemModal) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-96"> <h3 class="text-xl font-semibold mb-4">アイテム追加</h3> <div class="space-y-4"> <div> <label class="block">アイテム名</label> <input type="text" value="${state.itemForm.name}" oninput="state.itemForm.name = this.value" class="w-full input-bg rounded px-3 py-2"> </div> <div class="grid grid-cols-2 gap-4"> <div> <label>重量</label> <input type="number" min="0" value="${state.itemForm.weight}" oninput="state.itemForm.weight = Number(this.value)" class="w-full input-bg rounded px-3 py-2"/> </div> <div> <label>個数</label> <input type="number" min="1" value="${state.itemForm.quantity}" oninput="state.itemForm.quantity = Number(this.value)" class="w-full input-bg rounded px-3 py-2"/> </div> </div> <div> <label>売却金額</label> <input type="number" min="0" value="${state.itemForm.sellPrice}" oninput="state.itemForm.sellPrice = Number(this.value)" class="w-full input-bg rounded px-3 py-2"/> </div> <div> <label>種類</label> <select onchange="state.itemForm.type = this.value" class="w-full input-bg rounded px-3 py-2">${['武器','ポーション','食料','道具','矢弾','その他'].map(o => `<option value="${o}" ${state.itemForm.type === o ? 'selected' : ''}>${o}</option>`).join('')}</select> </div><div> <label>メモ</label> <textarea oninput="state.itemForm.memo = this.value" class="w-full input-bg rounded px-3 py-2">${state.itemForm.memo}</textarea> </div> </div> <div class="flex justify-end space-x-2 mt-6"> <button onclick="state.showItemModal = false; render();" class="btn">キャンセル</button> <button onclick="handleAddItem(state.showItemModal)" class="btn btn-secondary text-white">追加</button> </div> </div> </div>`; }
            if (state.showMoveModal) { modalHTML += `<div class="modal-overlay"> <div class="card-bg p-6 rounded-lg w-96"> <h3 class="text-xl font-semibold mb-4">アイテム移動</h3> <p class="mb-2"><strong>${state.moveItemData.item.name}</strong> を誰に渡しますか？</p> <div class="mb-4"> <label>渡す個数 (最大: ${state.moveItemData.item.quantity})</label> <input type="number" min="1" max="${state.moveItemData.item.quantity}" value="${state.moveItemData.quantity}" oninput="state.moveItemData.quantity = this.value" class="w-full input-bg rounded px-3 py-2"> </div> <div class="space-y-2 mb-6 max-h-64 overflow-y-auto"> <button onclick="handleMoveItem('storage')" class="btn w-full text-left p-3 border-color rounded hover-bg">共有倉庫</button> ${state.characters.filter(c => c.id !== state.moveItemData.source).map(character => `<button onclick="handleMoveItem(${character.id})" class="btn w-full text-left p-3 border-color rounded hover-bg">${character.name}</button>`).join('')} </div> <div class="flex justify-end"> <button onclick="state.showMoveModal = false; render();" class="btn">キャンセル</button> </div> </div> </div>`; }
            return modalHTML;
        }

        function fetchPartyList() { database.ref('party_meta').on('value', snapshot => { const data = snapshot.val() || {}; state.partyList = Object.keys(data).map(key => ({ id: key, meta: data[key] })); render(); }); }
        function initializeApp() {
            const savedTheme = localStorage.getItem('arianrod-theme') || 'dark';
            state.theme = savedTheme;
            const partyId = window.location.hash.substring(1);
            if (partyId) {
                if (state.partyId !== partyId) { database.ref('party_meta').off(); }
                state.partyId = partyId;
                setupDataListener();
            } else {
                if (state.partyId) { getPartyRef()?.off(); }
                Object.assign(state, { partyId: null, characters: [], sharedAssets: { money: 0 }, sharedStorage: [], logs: [], selectedCharacterId: null });
                fetchPartyList();
            }
        }
        window.addEventListener('hashchange', initializeApp);
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
